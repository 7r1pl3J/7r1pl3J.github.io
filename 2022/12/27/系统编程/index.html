<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="7r1p13J">





<title>系统编程实验 | Hexo</title>



    <link rel="icon" href="/github-11-48.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">7r1pl3J&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                    <a class="menu-item" href="/link">Links</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">7r1pl3J&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                    <a class="menu-item" href="/link">Links</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">系统编程实验</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">7r1p13J</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">December 27, 2022&nbsp;&nbsp;10:28:05</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/lab/">lab</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="系统编程实验"><a href="#系统编程实验" class="headerlink" title="系统编程实验"></a>系统编程实验</h1><p>szu系统编程实验</p>
<p>本地实现单机多用户聊天系统，架构图如下：</p>
<p><img src="https://blogimg-1314041910.cos.ap-guangzhou.myqcloud.com/image-20230104123824145.png" alt="image-20230104123824145"></p>
<p>实现功能：</p>
<ul>
<li>众所周知的命名管道</li>
<li>用户登录时，4次密码错误账号锁定10分钟。</li>
<li>为每个用户建立独立日志文件，日志文件收集用户事件信息</li>
<li>服务器采用多路复用（epoll）监听管道</li>
<li>服务器为守护进程</li>
<li>线程安全</li>
<li>线程池</li>
</ul>
<p>文件目录树：</p>
<p><img src="https://blogimg-1314041910.cos.ap-guangzhou.myqcloud.com/clip_image002.jpg" alt="img"></p>
<h2 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h2><p>IO多路复用是一种同步的IO模型。 利用IO多路复用模型，可以实现一个线程监视多个文件句柄。<br>以上图的模型来说，就是我们不需要创造4个线程去分别监听每一个FIFO管道，只需要用一个epoll就能同时监听四个管道了。</p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><p>epoll是为了处理大批量句柄而引进的一种poll，只有epoll_create,epoll_ctl,epoll_wait 3个系统调用。</p>
<h4 id="int-epoll-create-int-size"><a href="#int-epoll-create-int-size" class="headerlink" title="int epoll_create(int size);"></a><strong>int epoll_create(int size);</strong></h4><p>创建一个epoll的句柄。自从linux2.6.8之后，size参数是被忽略的。需要注意的是，当创建好epoll句柄后，它就是会占用一个fd值，在linux下如果查看&#x2F;proc&#x2F;进程id&#x2F;fd&#x2F;，是能够看到这个fd的，所以在使用完epoll后，必须调用close()关闭，否则可能导致fd被耗尽。</p>
<h4 id="int-epoll-ctl-int-epfd-int-op-int-fd-struct-epoll-event-event"><a href="#int-epoll-ctl-int-epfd-int-op-int-fd-struct-epoll-event-event" class="headerlink" title="int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);"></a><strong>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);</strong></h4><p>epoll的<strong>事件注册函数</strong>，它不同于select()是在监听事件时告诉内核要监听什么类型的事件，而是在这里先注册要监听的事件类型。</p>
<p>第一个参数是epoll_create()的返回值。</p>
<p>第二个参数表示动作，用三个宏来表示：</p>
<p>EPOLL_CTL_ADD：注册新的fd到epfd中；</p>
<p>EPOLL_CTL_MOD：修改已经注册的fd的监听事件；</p>
<p>EPOLL_CTL_DEL：从epfd中删除一个fd；</p>
<p>第三个参数是需要监听的fd。</p>
<p>第四个参数是告诉内核需要监听什么事</p>
<p>events可以是以下几个宏的集合：</p>
<p>EPOLLIN ：表示对应的文件描述符可以读（包括对端SOCKET正常关闭）；</p>
<p>EPOLLOUT：表示对应的文件描述符可以写；</p>
<p>EPOLLPRI：表示对应的文件描述符有紧急的数据可读（这里应该表示有带外数据到来）；</p>
<p>EPOLLERR：表示对应的文件描述符发生错误；</p>
<p>EPOLLHUP：表示对应的文件描述符被挂断；</p>
<p>EPOLLET： 将EPOLL设为边缘触发(Edge Triggered)模式，这是相对于水平触发(Level Triggered)来说的。</p>
<p>EPOLLONESHOT：只监听一次事件，当监听完这次事件之后，如果还需要继续监听这个socket的话，需要再次把这个socket加入到EPOLL队列里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line"><span class="type">__uint32_t</span> events; <span class="comment">/* Epoll events */</span></span><br><span class="line"><span class="type">epoll_data_t</span> data; <span class="comment">/* User data variable */</span></span><br><span class="line">&#125;;</span><br><span class="line">data成员是一个epoll_data联合，其定义如下：</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">epoll_data</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">uint32_t</span> u32;</span><br><span class="line">    <span class="type">uint64_t</span> u64;</span><br><span class="line">&#125; <span class="type">epoll_data_t</span>;</span><br></pre></td></tr></table></figure>

<h4 id="int-epoll-wait-int-epfd-struct-epoll-event-events-int-maxevents-int-timeout"><a href="#int-epoll-wait-int-epfd-struct-epoll-event-events-int-maxevents-int-timeout" class="headerlink" title="int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);"></a><strong>int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);</strong></h4><p>收集在epoll监控的事件中已经发送的事件。参数events是分配好的epoll_event结构体数组，epoll将会把发生的事件赋值到events数组中（events不可以是空指针，内核只负责把数据复制到这个events数组中，不会去帮助我们在用户态中分配内存）。maxevents告之内核这个events有多大，这个 maxevents的值不能大于创建epoll_create()时的size，参数timeout是超时时间（毫秒，0会立即返回，-1将不确定，也有说法说是永久阻塞）。如果函数调用成功，返回对应I&#x2F;O上已准备好的文件描述符数目，如返回0表示已超时。</p>
<h4 id="Epoll的2种工作方式-水平触发（LT）和边缘触发（ET）"><a href="#Epoll的2种工作方式-水平触发（LT）和边缘触发（ET）" class="headerlink" title="Epoll的2种工作方式-水平触发（LT）和边缘触发（ET）"></a><strong>Epoll的2种工作方式-水平触发（LT）和边缘触发（ET）</strong></h4><p>ET模式仅当状态发生变化的时候才获得通知,这里所谓的状态的变化并不包括缓冲区中还有未处理的数据,也就是说,如果要采用ET模式,需要一直read&#x2F;write直到出错为止,很多人反映为什么采用ET模式只接收了一部分数据就再也得不到通知了,大多因为这样;</p>
<p>而LT模式是只要有数据没有处理就会一直通知下去的.</p>
<p>使用模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( ; ; )</span><br><span class="line">    &#123;</span><br><span class="line">        nfds = epoll_wait(epfd,events,<span class="number">20</span>,<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;nfds;++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(events[i].data.fd==listenfd) <span class="comment">//有新的连接</span></span><br><span class="line">            &#123;</span><br><span class="line">                connfd = accept(listenfd,(sockaddr *)&amp;clientaddr, &amp;clilen); <span class="comment">//accept这个连接</span></span><br><span class="line">                ev.data.fd=connfd;</span><br><span class="line">                ev.events=EPOLLIN|EPOLLET;</span><br><span class="line">                epoll_ctl(epfd,EPOLL_CTL_ADD,connfd,&amp;ev); <span class="comment">//将新的fd添加到epoll的监听队列中</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>( events[i].events&amp;EPOLLIN ) <span class="comment">//接收到数据，读socket</span></span><br><span class="line">            &#123;</span><br><span class="line">                n = read(sockfd, line, MAXLINE)) &lt; <span class="number">0</span>    <span class="comment">//读</span></span><br><span class="line">                ev.data.ptr = md;     <span class="comment">//md为自定义类型，添加数据</span></span><br><span class="line">                ev.events=EPOLLOUT|EPOLLET;</span><br><span class="line">                epoll_ctl(epfd,EPOLL_CTL_MOD,sockfd,&amp;ev);<span class="comment">//修改标识符，等待下一个循环时发送数据，异步处理的精髓</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(events[i].events&amp;EPOLLOUT) <span class="comment">//有数据待发送，写socket</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">struct</span> myepoll_data* md = (myepoll_data*)events[i].data.ptr;    <span class="comment">//取数据</span></span><br><span class="line">                sockfd = md-&gt;fd;</span><br><span class="line">                send( sockfd, md-&gt;ptr, <span class="built_in">strlen</span>((<span class="type">char</span>*)md-&gt;ptr), <span class="number">0</span> );        <span class="comment">//发送数据</span></span><br><span class="line">                ev.data.fd=sockfd;</span><br><span class="line">                ev.events=EPOLLIN|EPOLLET;</span><br><span class="line">                epoll_ctl(epfd,EPOLL_CTL_MOD,sockfd,&amp;ev); <span class="comment">//修改标识符，等待下一个循环时接收数据</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//其他的处理</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="clieninfo-h"><a href="#clieninfo-h" class="headerlink" title="clieninfo.h"></a>clieninfo.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CLIENTINFO_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CLIENTINFO_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REG_FIFO <span class="string">&quot;/home/ubuntu/oslab/serverinfo/the_register_FIFO&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGIN_FIFO <span class="string">&quot;/home/ubuntu/oslab/serverinfo/the_login_FIFO&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_FIFO <span class="string">&quot;/home/ubuntu/oslab/serverinfo/the_msg_FIFO&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGOUT_FIFO <span class="string">&quot;/home/ubuntu/oslab/serverinfo/the_logout_FIFO&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_NAME <span class="string">&quot;chat_server&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGIN_SUCCESS 0x400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGIN_FAILED 0x401</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGIST_SUCCESS 0x402</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGIST_FAILED 0x403</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEND_SUCCESS 0x405</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEND_FAILED 0x404</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGOUT_SUCCESS 0x406</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGOUT_FAILED 0x407</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGIN_OVERTIMES 0x408</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// typedef union  &#123;</span></span><br><span class="line"><span class="comment">//     char receiver[0x50];</span></span><br><span class="line"><span class="comment">//     int oneline_num;</span></span><br><span class="line"><span class="comment">// &#125; receive;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> sender[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> receiver[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> message[<span class="number">0x200</span>];</span><br><span class="line">&#125;MESSAGE_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> userfifo[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> statfifo[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> username[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> passwd[<span class="number">0x50</span>];</span><br><span class="line">&#125;REG_LOGIN_INFO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> userfifo[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> statfifo[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> username[<span class="number">0x50</span>];</span><br><span class="line">&#125;LOGOUT_INFO;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">readline</span><span class="params">(<span class="type">int</span> fd,<span class="type">char</span> *str)</span>&#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        n=read(fd,str,<span class="number">1</span>);</span><br><span class="line">    &#125;<span class="keyword">while</span>(n&gt;<span class="number">0</span> &amp;&amp; (*str++ != <span class="string">&#x27;\x00&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span> (n&gt;<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">errorinfo</span><span class="params">(<span class="type">char</span> *str)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m %s \033[0m\n&quot;</span>,str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">itoa</span><span class="params">(<span class="type">int</span> value,<span class="type">char</span> str[],<span class="type">int</span> radix)</span> </span><br><span class="line">&#123; </span><br><span class="line">  <span class="type">char</span> temp[<span class="number">33</span>]; </span><br><span class="line">  <span class="type">char</span> *tp = temp; </span><br><span class="line">  <span class="type">int</span> i; </span><br><span class="line">  <span class="type">unsigned</span> v; </span><br><span class="line">  <span class="type">int</span> sign; </span><br><span class="line">  <span class="type">char</span> *sp; </span><br><span class="line">  <span class="keyword">if</span>(radix &gt; <span class="number">36</span> || radix &lt; <span class="number">1</span>) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">  sign = (radix == <span class="number">10</span> &amp;&amp; value &lt; <span class="number">0</span>); <span class="comment">//十进制负数 </span></span><br><span class="line">  <span class="keyword">if</span>(sign) </span><br><span class="line">    v = -value; </span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v = (<span class="type">unsigned</span>)value; </span><br><span class="line">  <span class="keyword">while</span>(v || tp == temp)       <span class="comment">//转化操作 </span></span><br><span class="line">  &#123; </span><br><span class="line">    i = v % radix; </span><br><span class="line">    v = v / radix; </span><br><span class="line">    <span class="keyword">if</span>(i &lt; <span class="number">10</span>) </span><br><span class="line">      *tp++ = i + <span class="string">&#x27;0&#x27;</span>; </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      *tp++ = i + <span class="string">&#x27;a&#x27;</span> - <span class="number">10</span>; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">if</span>(str == <span class="number">0</span>) </span><br><span class="line">    str = (<span class="type">char</span>*)<span class="built_in">malloc</span>((tp - temp) + sign + <span class="number">1</span>); </span><br><span class="line">  sp = str; </span><br><span class="line">  <span class="keyword">if</span>(sign)   <span class="comment">//是负数的话把负号先加入数组 </span></span><br><span class="line">    *sp++ = <span class="string">&#x27;-&#x27;</span>; </span><br><span class="line">  <span class="keyword">while</span>(tp &gt; temp) </span><br><span class="line">    *sp++ = *--tp; </span><br><span class="line">  *sp = <span class="number">0</span>; </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> str; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dealstr</span><span class="params">(<span class="type">char</span> *str)</span>&#123;</span><br><span class="line">    <span class="type">char</span> *p=str;</span><br><span class="line">    <span class="keyword">while</span>((*p)!=<span class="string">&#x27;\x00&#x27;</span>)&#123;c</span><br><span class="line">        <span class="title function_">if</span><span class="params">(*p==<span class="string">&#x27;\n&#x27;</span>)</span></span><br><span class="line">            *p=<span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line">        p++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="client-c"><a href="#client-c" class="headerlink" title="client.c"></a>client.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#gcc client.c -o client  -pthread -w</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;clientinfo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> regist_fd, login_fd, msg_fd, logout_fd;</span><br><span class="line"><span class="type">int</span> userfifo_fd, statfifo_fd;</span><br><span class="line"><span class="type">char</span> username[<span class="number">0x50</span>];</span><br><span class="line"><span class="type">char</span> userfifo[<span class="number">0x50</span>];</span><br><span class="line"><span class="type">char</span> passwd[<span class="number">0x50</span>];</span><br><span class="line"><span class="type">char</span> statfifo[<span class="number">0x50</span>];</span><br><span class="line"><span class="type">int</span> online_user_num;</span><br><span class="line"><span class="type">int</span> is_login = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// don&#x27;t save the passwd</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create_fifo</span><span class="params">(<span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line">    <span class="keyword">if</span> (access(str, F_OK) == <span class="number">-1</span>) &#123;</span><br><span class="line">        res = mkfifo(str, <span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">            errorinfo(<span class="string">&quot;[x] mkfifo failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">clinet_init</span><span class="params">()</span> &#123;</span><br><span class="line">    regist_fd = open(REG_FIFO, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (regist_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open regist FIFO failed&quot;</span>);</span><br><span class="line">    login_fd = open(LOGIN_FIFO, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (login_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open login FIFO failed&quot;</span>);</span><br><span class="line">    logout_fd = open(LOGOUT_FIFO, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (logout_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open logout FIFO failed&quot;</span>);</span><br><span class="line">    msg_fd = open(MSG_FIFO, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (msg_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open msg FIFO failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m --------------------CLIENT-------------------- \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m 1. register \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m 2. login \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m 3. exit \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m Welcome to the chatroom , pls take a choice : \033[0m&quot;</span>);</span><br><span class="line">    <span class="comment">// puts(&quot;\033[31m \033[0m&quot;);</span></span><br><span class="line">    <span class="comment">// puts(&quot;\033[31m \033[0m&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chat_menu</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;\033[32m --------------------CLIENT-------------------- user:%s &quot;</span></span><br><span class="line">        <span class="string">&quot;\033[0m\n&quot;</span>,</span><br><span class="line">        username);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m 1. start chat \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m 2. logout \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m 3. get online user info \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m Welcome to the chatroom , pls take a choice : \033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">login</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// char temp_passwd[0x50];</span></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m --------------------CLIENT-------------------- \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m username:  \033[0m&quot;</span>);</span><br><span class="line">    <span class="comment">// fflush(stdout);</span></span><br><span class="line">    <span class="comment">// fgets(username,0x50,stdin);</span></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, username);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m passwd:  \033[0m&quot;</span>);</span><br><span class="line">    <span class="comment">// fgets(passwd,0x50,stdin);</span></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, passwd);</span><br><span class="line">    REG_LOGIN_INFO login_info;</span><br><span class="line">    <span class="built_in">strcpy</span>(login_info.username, username);</span><br><span class="line">    <span class="built_in">strcpy</span>(login_info.passwd, passwd);</span><br><span class="line">    <span class="built_in">strcpy</span>(login_info.userfifo, userfifo);</span><br><span class="line">    <span class="built_in">strcpy</span>(login_info.statfifo, statfifo);</span><br><span class="line">    write(login_fd, &amp;login_info, <span class="keyword">sizeof</span>(REG_LOGIN_INFO));</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> n = read(statfifo_fd, buffer, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> result = atoi(buffer);</span><br><span class="line">            <span class="keyword">if</span> (result == LOGIN_SUCCESS) &#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(userfifo, <span class="string">&quot;/home/ubuntu/oslab/clientinfo/userfifo/client_%s_FIFO&quot;</span>,</span><br><span class="line">                        username);</span><br><span class="line">                <span class="built_in">sprintf</span>(statfifo, <span class="string">&quot;/home/ubuntu/oslab/clientinfo/statfifo/client_%s_stat&quot;</span>,</span><br><span class="line">                        username);</span><br><span class="line">                is_login = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[32m Login Success \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == LOGIN_FAILED) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Login failed ,pls try again \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == LOGIN_OVERTIMES) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Login overtimes , pls try at least 10 minutes later ...  \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;login error : 0x%x\n&quot;</span>, result);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">regist</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span> is_regist = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m --------------------CLIENT-------------------- \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m create username:  \033[0m&quot;</span>);</span><br><span class="line">    <span class="comment">// fflush(stdout);</span></span><br><span class="line">    <span class="comment">// fgets(username,0x50,stdin);</span></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, username);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m create passwd:  \033[0m&quot;</span>);</span><br><span class="line">    <span class="comment">// fflush(stdout);</span></span><br><span class="line">    <span class="comment">// fgets(passwd,0x50,stdin);</span></span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, passwd);</span><br><span class="line"></span><br><span class="line">    REG_LOGIN_INFO regist_info;</span><br><span class="line">    <span class="built_in">strcpy</span>(regist_info.username, username);</span><br><span class="line">    <span class="built_in">strcpy</span>(regist_info.passwd, passwd);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(userfifo, <span class="string">&quot;/home/ubuntu/oslab/clientinfo/userfifo/client_%s_FIFO&quot;</span>, username);</span><br><span class="line">    create_fifo(userfifo);</span><br><span class="line">    userfifo_fd = open(userfifo, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (userfifo_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open client FIFO failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(statfifo, <span class="string">&quot;/home/ubuntu/oslab/clientinfo/statfifo/client_%s_stat&quot;</span>, username);</span><br><span class="line">    create_fifo(statfifo);</span><br><span class="line">    statfifo_fd = open(statfifo, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (statfifo_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open stat FIFO failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(regist_info.userfifo, userfifo);</span><br><span class="line">    <span class="built_in">strcpy</span>(regist_info.statfifo, statfifo);</span><br><span class="line">    write(regist_fd, &amp;regist_info, <span class="keyword">sizeof</span>(REG_LOGIN_INFO));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> n = read(statfifo_fd, buffer, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> result = atoi(buffer);</span><br><span class="line">            <span class="keyword">if</span> (result == REGIST_SUCCESS) &#123;</span><br><span class="line">                is_regist = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[32m Regist Success \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == REGIST_FAILED) &#123;</span><br><span class="line">                close(userfifo_fd);</span><br><span class="line">                close(statfifo_fd);</span><br><span class="line">                <span class="built_in">memset</span>(userfifo, <span class="number">0</span>, <span class="number">0x50</span>);</span><br><span class="line">                <span class="built_in">memset</span>(statfifo, <span class="number">0</span>, <span class="number">0x50</span>);</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Regist failed ,pls try again \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;regist error : 0x%x\n&quot;</span>, result);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">memset</span>(username, <span class="number">0</span>, <span class="number">0x50</span>);</span><br><span class="line">            <span class="comment">// memset(userfifo,0,0x50);</span></span><br><span class="line">            <span class="built_in">memset</span>(passwd, <span class="number">0</span>, <span class="number">0x50</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">chat</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> receiver_name[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> message[<span class="number">0x200</span>];</span><br><span class="line">    <span class="type">int</span> is_send = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m --------------------CLIENT-------------------- \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m Hello %s , start your chat ... \033[0m&quot;</span>, username);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m receiver name:  \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, receiver_name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m your message:  \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">    MESSAGE_INFO msg_info;</span><br><span class="line">    <span class="built_in">strcpy</span>(msg_info.sender, username);</span><br><span class="line">    <span class="built_in">strcpy</span>(msg_info.message, message);</span><br><span class="line">    <span class="built_in">strcpy</span>(msg_info.receiver, receiver_name);</span><br><span class="line">    write(msg_fd, &amp;msg_info, <span class="keyword">sizeof</span>(MESSAGE_INFO));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> n = read(statfifo_fd, buffer, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> result = atoi(buffer);</span><br><span class="line">            <span class="keyword">if</span> (result == SEND_SUCCESS) &#123;</span><br><span class="line">                is_send = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[32m Send Success \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == SEND_FAILED) &#123;</span><br><span class="line">                is_send = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Send failed ,pls try again \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;send error : 0x%x\n&quot;</span>, result);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">logout</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> receiver_name[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> message[<span class="number">0x200</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m --------------------CLIENT-------------------- \033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m logout ... \033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    LOGOUT_INFO logout_info;</span><br><span class="line">    <span class="built_in">strcpy</span>(logout_info.username, username);</span><br><span class="line">    <span class="built_in">strcpy</span>(logout_info.userfifo, userfifo);</span><br><span class="line">    <span class="built_in">strcpy</span>(logout_info.statfifo, statfifo);</span><br><span class="line">    write(logout_fd, &amp;logout_info, <span class="keyword">sizeof</span>(LOGOUT_INFO));</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> n = read(statfifo_fd, buffer, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> result = atoi(buffer);</span><br><span class="line">            <span class="keyword">if</span> (result == LOGOUT_SUCCESS) &#123;</span><br><span class="line"></span><br><span class="line">                is_login = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[32m Logout Success \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == LOGOUT_FAILED) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Logout failed ,pls try again \033[0m&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Logout error ,pls try again \033[0m&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_onelineinfo</span><span class="params">()</span>&#123;</span><br><span class="line">    MESSAGE_INFO msg_info;</span><br><span class="line">    <span class="built_in">strcpy</span>(msg_info.sender, username);</span><br><span class="line">    <span class="built_in">strcpy</span>(msg_info.receiver, SERVER_NAME);</span><br><span class="line">    <span class="type">int</span> n=write(msg_fd, &amp;msg_info, <span class="keyword">sizeof</span>(MESSAGE_INFO));</span><br><span class="line">    <span class="keyword">if</span>(n&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Get online info failed ,pls try again \033[0m&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">receive_thread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// char buffer[sizeof(MESSAGE_INFO)];</span></span><br><span class="line">    MESSAGE_INFO msg_info;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> n = read(userfifo_fd, &amp;msg_info, <span class="keyword">sizeof</span>(MESSAGE_INFO));</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* normal msg */</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(msg_info.sender,SERVER_NAME))&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\n Receiver mssage from %s : %s\n \033[0m&quot;</span>,</span><br><span class="line">                    msg_info.sender, msg_info.message);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">/* online info */</span></span><br><span class="line">                online_user_num = atoi(msg_info.receiver);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\n Oneline user num : %d \n\033[0m&quot;</span>,</span><br><span class="line">                       online_user_num);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[34m Oneline user name list :  \033[0m&quot;</span></span><br><span class="line">                       );</span><br><span class="line">                <span class="built_in">puts</span>(msg_info.message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> choice, n;</span><br><span class="line">    clinet_init();</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        menu();</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;choice);</span><br><span class="line">        <span class="keyword">switch</span> (choice) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                regist();</span><br><span class="line">                <span class="comment">// four times</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                login();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Invalid choice ,pls try again \033[0m&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_login) &#123;</span><br><span class="line">            <span class="type">pthread_t</span> ptd;</span><br><span class="line">            pthread_create(&amp;ptd, <span class="literal">NULL</span>, receive_thread, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">int</span> chat_choice;</span><br><span class="line">                chat_menu();</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;chat_choice);</span><br><span class="line">                <span class="keyword">switch</span> (chat_choice) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                        chat();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                        logout();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                        get_onelineinfo();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m Invalid choice ,pls try again \033[0m&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( !is_login) &#123;</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m Restart ... \033[0m&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="server-c"><a href="#server-c" class="headerlink" title="server.c"></a>server.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#gcc server.c -o server -lpthread -w</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/param.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;clientinfo.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;threadpool.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLK_TCK 1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_USER_NUM 0x50</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCK_TIME 1000 * 60 * 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_THREAD_NUM 4</span></span><br><span class="line"><span class="comment">//  typedef union epoll_data &#123;</span></span><br><span class="line"><span class="comment">//     void    *ptr;</span></span><br><span class="line"><span class="comment">//     int      fd;</span></span><br><span class="line"><span class="comment">//     uint32_t u32;</span></span><br><span class="line"><span class="comment">//     uint64_t u64;</span></span><br><span class="line"><span class="comment">// &#125; epoll_data_t;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// struct epoll_event &#123;</span></span><br><span class="line"><span class="comment">//     uint32_t     events;    /* Epoll events */</span></span><br><span class="line"><span class="comment">//     epoll_data_t data;      /* User data variable */</span></span><br><span class="line"><span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">online_user</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> userfifo[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> statfifo[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> username[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> passwd[<span class="number">0x50</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">online_user</span>* <span class="title">next</span>;</span></span><br><span class="line">&#125; USERLIST;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> userfifo[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> statfifo[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> username[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> passwd[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">int</span> login_times;</span><br><span class="line">    <span class="type">clock_t</span> start_time;</span><br><span class="line">    <span class="type">clock_t</span> end_time;</span><br><span class="line">&#125; USER_INFO;</span><br><span class="line"></span><br><span class="line">USERLIST* ONLINE_USERLIST;</span><br><span class="line"><span class="type">int</span> regist_fd, login_fd, msg_fd, logout_fd;</span><br><span class="line"><span class="type">int</span> user_num = <span class="number">0</span>, oneline_user_num = <span class="number">0</span>;  <span class="comment">// danger</span></span><br><span class="line">USER_INFO USERINFO_DATA[MAX_USER_NUM];</span><br><span class="line"><span class="type">tpool_t</span>* pool;</span><br><span class="line"><span class="type">pthread_mutex_t</span> usernum_mutex, onlinenum_mutex, list_mutex;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">online_user_add</span><span class="params">(USERLIST* <span class="built_in">list</span>)</span> &#123;</span><br><span class="line">    USERLIST* p = ONLINE_USERLIST;</span><br><span class="line">    <span class="keyword">while</span> ((p-&gt;next) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        p = p-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    p-&gt;next = <span class="built_in">list</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">oneline_user_delete</span><span class="params">(<span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    USERLIST* p = ONLINE_USERLIST;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">strcmp</span>(p-&gt;next-&gt;username, str)) &#123;</span><br><span class="line">        p = p-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    USERLIST* temp = p-&gt;next;</span><br><span class="line">    p-&gt;next = temp-&gt;next;</span><br><span class="line">    <span class="built_in">free</span>(temp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_oneline_username</span><span class="params">(<span class="type">char</span>* usernamebuf)</span> &#123;</span><br><span class="line">    USERLIST* p = ONLINE_USERLIST;</span><br><span class="line">    <span class="type">char</span>* namebuf_index = usernamebuf;</span><br><span class="line">    <span class="keyword">while</span> ((p-&gt;next) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        p = p-&gt;next;</span><br><span class="line">        <span class="comment">// printf(&quot;username:%s\n&quot;, p-&gt;username);</span></span><br><span class="line">        <span class="built_in">strcpy</span>(namebuf_index, p-&gt;username);</span><br><span class="line">        namebuf_index += <span class="built_in">strlen</span>(p-&gt;username);</span><br><span class="line">        *(namebuf_index) = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        *(++namebuf_index) = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">epoll_add_event</span><span class="params">(<span class="type">int</span> epoll_fd, <span class="type">int</span> fd, <span class="type">int</span> event)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></span><br><span class="line">    ev.events = event;</span><br><span class="line">    ev.data.fd = fd;</span><br><span class="line">    epoll_ctl(epoll_fd, EPOLL_CTL_ADD, fd, &amp;ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create_fifo</span><span class="params">(<span class="type">char</span>* str)</span> &#123;</span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line">    <span class="keyword">if</span> (access(str, F_OK) == <span class="number">-1</span>) &#123;</span><br><span class="line">        res = mkfifo(str, <span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">            errorinfo(<span class="string">&quot;[x] mkfifo failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">gettime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">clock_t</span> current_time;</span><br><span class="line">    time(&amp;current_time);</span><br><span class="line">    <span class="keyword">return</span> asctime(gmtime(&amp;current_time));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create_log</span><span class="params">(<span class="type">char</span>* username)</span> &#123;</span><br><span class="line">    <span class="type">char</span> userlog[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> log_buffer[<span class="number">0x50</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(userlog, <span class="string">&quot;/home/ubuntu/oslab/serverinfo/user_log/%s_log&quot;</span>, username);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> log_fd = open(userlog, O_RDWR | O_NONBLOCK | O_CREAT | O_APPEND);</span><br><span class="line">    <span class="keyword">if</span> (log_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;open user_log failed&quot;</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(log_buffer, <span class="string">&quot; %s regist %s \n&quot;</span>, username, gettime());</span><br><span class="line">    <span class="type">int</span> n = write(log_fd, log_buffer, <span class="built_in">strlen</span>(log_buffer + <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// if (n &lt; 0) &#123;</span></span><br><span class="line">    <span class="comment">//     puts(&quot;[x] write user_log failed&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    close(log_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">login_log</span><span class="params">(<span class="type">char</span>* username)</span> &#123;</span><br><span class="line">    <span class="type">char</span> userlog[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> log_buffer[<span class="number">0x50</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(userlog, <span class="string">&quot;/home/ubuntu/oslab/serverinfo/user_log/%s_log&quot;</span>, username);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> log_fd = open(userlog, O_RDWR | O_NONBLOCK | O_APPEND);</span><br><span class="line">    <span class="keyword">if</span> (log_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;open user_log failed&quot;</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(log_buffer, <span class="string">&quot;%s login %s \n&quot;</span>, username, gettime());</span><br><span class="line">    <span class="type">int</span> n = write(log_fd, log_buffer, <span class="built_in">strlen</span>(log_buffer + <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// if (n &lt; 0) &#123;</span></span><br><span class="line">    <span class="comment">//     puts(&quot;[x] write user_log failed&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    close(log_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">logout_log</span><span class="params">(<span class="type">char</span>* username)</span> &#123;</span><br><span class="line">    <span class="type">char</span> userlog[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> log_buffer[<span class="number">0x50</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(userlog, <span class="string">&quot;/home/ubuntu/oslab/serverinfo/user_log/%s_log&quot;</span>, username);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> log_fd = open(userlog, O_RDWR | O_NONBLOCK | O_APPEND);</span><br><span class="line">    <span class="keyword">if</span> (log_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;open user_log failed&quot;</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(log_buffer, <span class="string">&quot;%s logout %s \n&quot;</span>, username, gettime());</span><br><span class="line">    <span class="type">int</span> n = write(log_fd, log_buffer, <span class="built_in">strlen</span>(log_buffer + <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// if (n &lt; 0) &#123;</span></span><br><span class="line">    <span class="comment">//     puts(&quot;[x] write user_log failed&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    close(log_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">msg_log</span><span class="params">(<span class="type">char</span>* sender, <span class="type">char</span>* receiver, <span class="type">int</span> success)</span> &#123;</span><br><span class="line">    <span class="type">char</span> sender_log[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> receiver_log[<span class="number">0x50</span>];</span><br><span class="line">    <span class="type">char</span> log_buffer[<span class="number">0x50</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(sender_log, <span class="string">&quot;/home/ubuntu/oslab/serverinfo/user_log/%s_log&quot;</span>,</span><br><span class="line">            sender);</span><br><span class="line">    <span class="type">int</span> sender_log_fd = open(sender_log, O_RDWR | O_NONBLOCK | O_APPEND);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(receiver_log, <span class="string">&quot;/home/ubuntu/oslab/serverinfo/user_log/%s_log&quot;</span>,</span><br><span class="line">                receiver);</span><br><span class="line">        <span class="type">int</span> receiver_log_fd =</span><br><span class="line">            open(receiver_log, O_RDWR | O_NONBLOCK | O_APPEND);</span><br><span class="line">        <span class="keyword">if</span> (sender_log_fd &lt; <span class="number">0</span> || receiver_log_fd &lt; <span class="number">0</span>)</span><br><span class="line">            errorinfo(<span class="string">&quot;open user_log failed&quot;</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(log_buffer, <span class="string">&quot;%s send messaget to %s (success). %s\n&quot;</span>, sender,</span><br><span class="line">                receiver, gettime());</span><br><span class="line">        <span class="type">int</span> n, m;</span><br><span class="line">        n = write(receiver_log_fd, log_buffer, <span class="built_in">strlen</span>(log_buffer + <span class="number">1</span>));</span><br><span class="line">        m = write(sender_log_fd, log_buffer, <span class="built_in">strlen</span>(log_buffer + <span class="number">1</span>));</span><br><span class="line">        <span class="comment">// if (n &lt; 0 || m &lt; 0) &#123;</span></span><br><span class="line">        <span class="comment">//     puts(&quot;[x] write user_log failed&quot;);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        close(receiver_log_fd);</span><br><span class="line">        close(sender_log_fd);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sender_log_fd &lt; <span class="number">0</span>)</span><br><span class="line">            errorinfo(<span class="string">&quot;open user_log failed&quot;</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(log_buffer, <span class="string">&quot;%s send messaget to %s (failed). %s\n&quot;</span>, sender,</span><br><span class="line">                receiver, gettime());</span><br><span class="line">        <span class="type">int</span> n = write(sender_log_fd, log_buffer, <span class="built_in">strlen</span>(log_buffer + <span class="number">1</span>));</span><br><span class="line">        <span class="comment">// if (n &lt; 0) &#123;</span></span><br><span class="line">        <span class="comment">//     puts(&quot;[x] write user_log failed&quot;);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        close(sender_log_fd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fifo_init</span><span class="params">()</span> &#123;</span><br><span class="line">    create_fifo(REG_FIFO);</span><br><span class="line">    create_fifo(LOGIN_FIFO);</span><br><span class="line">    create_fifo(MSG_FIFO);</span><br><span class="line">    create_fifo(LOGOUT_FIFO);</span><br><span class="line">    regist_fd = open(REG_FIFO, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (regist_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open regist FIFO failed&quot;</span>);</span><br><span class="line">    login_fd = open(LOGIN_FIFO, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (login_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open login FIFO failed&quot;</span>);</span><br><span class="line">    logout_fd = open(LOGOUT_FIFO, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (logout_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open logout FIFO failed&quot;</span>);</span><br><span class="line">    msg_fd = open(MSG_FIFO, O_RDWR | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (msg_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] open msg FIFO failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">profile_init</span><span class="params">()</span> &#123;</span><br><span class="line">    ONLINE_USERLIST = (USERLIST*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(USERLIST));</span><br><span class="line">    ONLINE_USERLIST-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;usernum_mutex, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_init(&amp;onlinenum_mutex, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_init(&amp;list_mutex, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pool = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (create_tpool(&amp;pool, MAX_THREAD_NUM) != <span class="number">0</span>) &#123;</span><br><span class="line">        errorinfo(<span class="string">&quot;create_tpool failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">login_thread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// puts(&quot;[+] login thread start ...&quot;);</span></span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line">    REG_LOGIN_INFO login_info;</span><br><span class="line">    <span class="type">int</span> statinfo_fd;</span><br><span class="line">    <span class="type">int</span> is_success = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> is_overtimes = <span class="number">0</span>;</span><br><span class="line">    res = read(login_fd, &amp;login_info, <span class="keyword">sizeof</span>(REG_LOGIN_INFO));</span><br><span class="line">    <span class="keyword">if</span> (res &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; user_num; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(login_info.username, USERINFO_DATA[i].username)) &#123;</span><br><span class="line">                <span class="comment">// find the username</span></span><br><span class="line">                <span class="keyword">if</span> (USERINFO_DATA[i].login_times &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">                    is_overtimes = <span class="number">1</span>;</span><br><span class="line">                    USERINFO_DATA[i].end_time = clock();</span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">if</span> (((USERINFO_DATA[i].end_time -</span><br><span class="line">                          USERINFO_DATA[i].start_time)) &gt; LOCK_TIME) &#123;</span><br><span class="line"></span><br><span class="line">                        is_overtimes = <span class="number">0</span>;</span><br><span class="line">                        USERINFO_DATA[i].login_times = <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(login_info.passwd,</span><br><span class="line">                            USERINFO_DATA[i].passwd)) &#123;  <span class="comment">// login success</span></span><br><span class="line">                    <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">                    itoa(LOGIN_SUCCESS, buf, <span class="number">10</span>);</span><br><span class="line">                    statinfo_fd =</span><br><span class="line">                        open(login_info.statfifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">                    <span class="keyword">if</span> (statinfo_fd &lt; <span class="number">0</span>)</span><br><span class="line">                        errorinfo(<span class="string">&quot;[x] login_thread open statfifo failed&quot;</span>);</span><br><span class="line">                    write(statinfo_fd, buf, <span class="number">10</span>);</span><br><span class="line">                    close(statinfo_fd);</span><br><span class="line">                    is_success = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    pthread_mutex_lock(&amp;list_mutex);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!(ONLINE_USERLIST-&gt;next)) &#123;  <span class="comment">// list head</span></span><br><span class="line"></span><br><span class="line">                        USERLIST* user = (USERLIST*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(USERLIST));</span><br><span class="line">                        <span class="built_in">strcpy</span>(user-&gt;userfifo, login_info.userfifo);</span><br><span class="line">                        <span class="built_in">strcpy</span>(user-&gt;username, login_info.username);</span><br><span class="line">                        <span class="built_in">strcpy</span>(user-&gt;statfifo, login_info.statfifo);</span><br><span class="line">                        <span class="built_in">strcpy</span>(user-&gt;passwd, login_info.passwd);</span><br><span class="line">                        user-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                        ONLINE_USERLIST-&gt;next = user;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// add list</span></span><br><span class="line">                        USERLIST* user = (USERLIST*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(USERLIST));</span><br><span class="line">                        <span class="built_in">strcpy</span>(user-&gt;userfifo, login_info.userfifo);</span><br><span class="line">                        <span class="built_in">strcpy</span>(user-&gt;username, login_info.username);</span><br><span class="line">                        <span class="built_in">strcpy</span>(user-&gt;statfifo, login_info.statfifo);</span><br><span class="line">                        <span class="built_in">strcpy</span>(user-&gt;passwd, login_info.passwd);</span><br><span class="line">                        user-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                        online_user_add(user);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    pthread_mutex_unlock(&amp;list_mutex);</span><br><span class="line"></span><br><span class="line">                    pthread_mutex_lock(&amp;onlinenum_mutex);</span><br><span class="line">                    oneline_user_num++;  <span class="comment">// mutex</span></span><br><span class="line">                    pthread_mutex_unlock(&amp;onlinenum_mutex);</span><br><span class="line">                    login_log(login_info.username);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">/* passwd error */</span></span><br><span class="line">                    <span class="keyword">if</span> (!USERINFO_DATA[i].start_time) &#123;</span><br><span class="line">                        USERINFO_DATA[i].start_time = clock();</span><br><span class="line">                        <span class="comment">// printf(&quot;start:%d\n&quot;, USERINFO_DATA[i].start_time);</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    USERINFO_DATA[i].login_times++;</span><br><span class="line">                    <span class="comment">// printf(&quot;login times:%d\n&quot;, USERINFO_DATA[i].login_times);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!is_success) &#123;</span><br><span class="line">            <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">            <span class="keyword">if</span> (is_overtimes) &#123;</span><br><span class="line">                itoa(LOGIN_OVERTIMES, buf, <span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                itoa(LOGIN_FAILED, buf, <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            statinfo_fd = open(login_info.statfifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">            <span class="keyword">if</span> (statinfo_fd &lt; <span class="number">0</span>)</span><br><span class="line">                errorinfo(<span class="string">&quot;[x] login_thread open statfifo failed&quot;</span>);</span><br><span class="line">            write(statinfo_fd, buf, <span class="number">10</span>);</span><br><span class="line">            close(statinfo_fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">regist_thread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// puts(&quot;[+] regist thread start ...&quot;);</span></span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line">    REG_LOGIN_INFO regist_info;</span><br><span class="line">    <span class="type">int</span> statinfo_fd;</span><br><span class="line">    <span class="type">int</span> is_success = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    res = read(regist_fd, &amp;regist_info, <span class="keyword">sizeof</span>(REG_LOGIN_INFO));</span><br><span class="line">    <span class="keyword">if</span> (res &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; user_num; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(regist_info.username,</span><br><span class="line">                        USERINFO_DATA[i].username)) &#123;  <span class="comment">// username same</span></span><br><span class="line">                is_success = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_success) &#123;  <span class="comment">// regist success</span></span><br><span class="line">            pthread_mutex_lock(&amp;usernum_mutex);</span><br><span class="line">            <span class="type">int</span> i = user_num++;</span><br><span class="line">            pthread_mutex_unlock(&amp;usernum_mutex);</span><br><span class="line">            <span class="built_in">strcpy</span>(USERINFO_DATA[i].username, regist_info.username);</span><br><span class="line">            <span class="built_in">strcpy</span>(USERINFO_DATA[i].passwd, regist_info.passwd);</span><br><span class="line">            <span class="built_in">strcpy</span>(USERINFO_DATA[i].userfifo, regist_info.userfifo);</span><br><span class="line">            <span class="built_in">strcpy</span>(USERINFO_DATA[i].statfifo, regist_info.statfifo);</span><br><span class="line">            <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">            itoa(REGIST_SUCCESS, buf, <span class="number">10</span>);</span><br><span class="line">            statinfo_fd = open(regist_info.statfifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">            <span class="keyword">if</span> (statinfo_fd &lt; <span class="number">0</span>)</span><br><span class="line">                errorinfo(<span class="string">&quot;[x] regist_thread open statfifo failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">            create_log(regist_info.username);</span><br><span class="line"></span><br><span class="line">            write(statinfo_fd, buf, <span class="number">10</span>);</span><br><span class="line">            close(statinfo_fd);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  <span class="comment">// regist failed : username same</span></span><br><span class="line">            <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">            itoa(REGIST_FAILED, buf, <span class="number">10</span>);</span><br><span class="line">            statinfo_fd = open(regist_info.statfifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">            <span class="keyword">if</span> (statinfo_fd &lt; <span class="number">0</span>)</span><br><span class="line">                errorinfo(<span class="string">&quot;[x] regist_thread open statfifo failed&quot;</span>);</span><br><span class="line">            write(statinfo_fd, buf, <span class="number">10</span>);</span><br><span class="line">            close(statinfo_fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">msg_thread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// puts(&quot;[+] msg thread start ...&quot;);</span></span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line">    MESSAGE_INFO msg_info;</span><br><span class="line">    <span class="type">int</span> receiver_fd;</span><br><span class="line">    <span class="type">int</span> is_send = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    res = read(msg_fd, &amp;msg_info, <span class="keyword">sizeof</span>(MESSAGE_INFO));</span><br><span class="line">    <span class="keyword">if</span> (res &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* normal msg  */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(msg_info.receiver, SERVER_NAME)) &#123;</span><br><span class="line">            <span class="type">char</span> receiver_fifo[<span class="number">0x50</span>];</span><br><span class="line">            <span class="comment">//@TODO sender</span></span><br><span class="line">            <span class="built_in">sprintf</span>(receiver_fifo,</span><br><span class="line">                    <span class="string">&quot;/home/ubuntu/oslab/clientinfo/userfifo/client_%s_FIFO&quot;</span>,</span><br><span class="line">                    msg_info.receiver);</span><br><span class="line">            receiver_fd = open(receiver_fifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">            <span class="keyword">if</span> (receiver_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;[x] msg_thread open failed&quot;</span>);</span><br><span class="line">                is_send = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//@TODO log</span></span><br><span class="line">            <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">            <span class="type">char</span> sender_fifo[<span class="number">0x50</span>];</span><br><span class="line">            <span class="built_in">sprintf</span>(sender_fifo,</span><br><span class="line">                    <span class="string">&quot;/home/ubuntu/oslab/clientinfo/statfifo/client_%s_stat&quot;</span>,</span><br><span class="line">                    msg_info.sender);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (is_send) &#123;</span><br><span class="line">                write(receiver_fd, &amp;msg_info, <span class="keyword">sizeof</span>(MESSAGE_INFO));</span><br><span class="line">                close(receiver_fd);</span><br><span class="line">                msg_log(msg_info.sender, msg_info.receiver, is_send);</span><br><span class="line"></span><br><span class="line">                itoa(SEND_SUCCESS, buf, <span class="number">10</span>);</span><br><span class="line">                <span class="type">int</span> sender_fd = open(sender_fifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">                <span class="keyword">if</span> (sender_fd &lt; <span class="number">0</span>)</span><br><span class="line">                    errorinfo(<span class="string">&quot;[x] msg_thread open userfifo failed&quot;</span>);</span><br><span class="line">                write(sender_fd, buf, <span class="number">10</span>);</span><br><span class="line">                close(sender_fd);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                msg_log(msg_info.sender, msg_info.receiver, is_send);</span><br><span class="line"></span><br><span class="line">                itoa(SEND_FAILED, buf, <span class="number">10</span>);</span><br><span class="line">                <span class="type">int</span> sender_fd = open(sender_fifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">                <span class="keyword">if</span> (sender_fd &lt; <span class="number">0</span>)</span><br><span class="line">                    errorinfo(<span class="string">&quot;[x] msg_thread open userfifo failed&quot;</span>);</span><br><span class="line">                write(sender_fd, buf, <span class="number">10</span>);</span><br><span class="line">                close(sender_fd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* return online info */</span></span><br><span class="line"></span><br><span class="line">            <span class="type">char</span> receiver_fifo[<span class="number">0x50</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">sprintf</span>(receiver_fifo,</span><br><span class="line">                    <span class="string">&quot;/home/ubuntu/oslab/clientinfo/userfifo/client_%s_FIFO&quot;</span>,</span><br><span class="line">                    msg_info.sender);</span><br><span class="line">            receiver_fd = open(receiver_fifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">            <span class="comment">// if (receiver_fd &lt; 0) &#123;</span></span><br><span class="line">            <span class="comment">//     puts(&quot;[x] msg_thread open failed&quot;);</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">            <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">            get_oneline_username(msg_info.message);</span><br><span class="line">            itoa(oneline_user_num, buf, <span class="number">10</span>);</span><br><span class="line">            <span class="built_in">strcpy</span>(msg_info.receiver, buf);</span><br><span class="line">            <span class="built_in">strcpy</span>(msg_info.sender, SERVER_NAME);</span><br><span class="line">            write(receiver_fd, &amp;msg_info, <span class="keyword">sizeof</span>(MESSAGE_INFO));</span><br><span class="line">            close(receiver_fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">logout_thread</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// puts(&quot;[+] logout thread start ...&quot;);</span></span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line">    LOGOUT_INFO logout_info;</span><br><span class="line">    <span class="type">int</span> statinfo_fd;</span><br><span class="line">    <span class="type">int</span> is_find = <span class="number">0</span>;</span><br><span class="line">    res = read(logout_fd, &amp;logout_info, <span class="keyword">sizeof</span>(LOGOUT_INFO));</span><br><span class="line">    <span class="keyword">if</span> (res &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//@TODO list find</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; user_num; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(USERINFO_DATA[i].username, logout_info.username)) &#123;</span><br><span class="line">                is_find = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// USERLIST* p = ONLINE_USERLIST;</span></span><br><span class="line">        <span class="comment">// while (p-&gt;next!=NULL) &#123;</span></span><br><span class="line">        <span class="comment">//     is_find = !(strcmp(p-&gt;next-&gt;username, logout_info.username));</span></span><br><span class="line">        <span class="comment">//     p = p-&gt;next;</span></span><br><span class="line">        <span class="comment">//     if(is_find)</span></span><br><span class="line">        <span class="comment">//         break;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_find) &#123;</span><br><span class="line">            pthread_mutex_lock(&amp;list_mutex);</span><br><span class="line">            oneline_user_delete(logout_info.username);</span><br><span class="line">            pthread_mutex_unlock(&amp;list_mutex);</span><br><span class="line"></span><br><span class="line">            pthread_mutex_lock(&amp;onlinenum_mutex);</span><br><span class="line">            oneline_user_num--;</span><br><span class="line">            pthread_mutex_unlock(&amp;onlinenum_mutex);</span><br><span class="line">            <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">            itoa(LOGOUT_SUCCESS, buf, <span class="number">10</span>);</span><br><span class="line">            statinfo_fd = open(logout_info.statfifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">            <span class="keyword">if</span> (statinfo_fd &lt; <span class="number">0</span>)</span><br><span class="line">                errorinfo(<span class="string">&quot;[x] logout_thread open statfifo failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">            logout_log(logout_info.username);</span><br><span class="line">            write(statinfo_fd, buf, <span class="number">10</span>);</span><br><span class="line">            close(statinfo_fd);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">            itoa(LOGOUT_FAILED, buf, <span class="number">10</span>);</span><br><span class="line">            statinfo_fd = open(logout_info.statfifo, O_WRONLY | O_NONBLOCK);</span><br><span class="line">            <span class="keyword">if</span> (statinfo_fd &lt; <span class="number">0</span>)</span><br><span class="line">                errorinfo(<span class="string">&quot;[x] logout_thread open statfifo failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">            write(statinfo_fd, buf, <span class="number">10</span>);</span><br><span class="line">            close(statinfo_fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> ptd_1, ptd_2, ptd_3, ptd_4;</span><br><span class="line">    pthread_create(&amp;ptd_1, <span class="literal">NULL</span>, regist_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;ptd_2, <span class="literal">NULL</span>, login_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;ptd_3, <span class="literal">NULL</span>, msg_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;ptd_4, <span class="literal">NULL</span>, logout_thread, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">monitor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">events</span>[4];</span></span><br><span class="line">    <span class="type">int</span> task_num = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> epoll_fd = epoll_create(<span class="number">4</span>);  <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (epoll_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] epoll create failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    epoll_add_event(epoll_fd, login_fd, EPOLLIN | EPOLLET);</span><br><span class="line">    epoll_add_event(epoll_fd, regist_fd, EPOLLIN | EPOLLET);</span><br><span class="line">    epoll_add_event(epoll_fd, msg_fd, EPOLLIN | EPOLLET);</span><br><span class="line">    epoll_add_event(epoll_fd, logout_fd, EPOLLIN | EPOLLET);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">int</span> num = epoll_wait(epoll_fd, events, <span class="number">4</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)</span><br><span class="line">            errorinfo(<span class="string">&quot;[x] epoll wait&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">pthread_t</span> ptd_1, ptd_2, ptd_3, ptd_4;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span> =</span> events[i];</span><br><span class="line">            <span class="keyword">if</span> (ev.data.fd == login_fd &amp;&amp; ev.events &amp; EPOLLIN) &#123;</span><br><span class="line">                <span class="comment">// pthread_create(&amp;ptd_2, NULL, login_thread, NULL);</span></span><br><span class="line">                add_task_2_tpool(pool, login_thread, <span class="literal">NULL</span>);</span><br><span class="line">                epoll_add_event(epoll_fd, login_fd, EPOLLIN | EPOLLET);</span><br><span class="line">                <span class="comment">// pthread_join(ptd_2, NULL);</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ev.data.fd == regist_fd &amp;&amp; ev.events &amp; EPOLLIN) &#123;</span><br><span class="line">                <span class="comment">// pthread_create(&amp;ptd_1, NULL, regist_thread, NULL);</span></span><br><span class="line">                add_task_2_tpool(pool, regist_thread, <span class="literal">NULL</span>);</span><br><span class="line">                epoll_add_event(epoll_fd, regist_fd, EPOLLIN | EPOLLET);</span><br><span class="line">                <span class="comment">// pthread_join(ptd_1, NULL);</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ev.data.fd == msg_fd &amp;&amp; ev.events &amp; EPOLLIN) &#123;</span><br><span class="line">                <span class="comment">// pthread_create(&amp;ptd_3, NULL, msg_thread, NULL);</span></span><br><span class="line">                add_task_2_tpool(pool, msg_thread, <span class="literal">NULL</span>);</span><br><span class="line">                epoll_add_event(epoll_fd, msg_fd, EPOLLIN | EPOLLET);</span><br><span class="line">                <span class="comment">// pthread_join(ptd_3, NULL);</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ev.data.fd == logout_fd &amp;&amp; ev.events &amp; EPOLLIN) &#123;</span><br><span class="line">                <span class="comment">// pthread_create(&amp;ptd_4, NULL, logout_thread, NULL);</span></span><br><span class="line">                add_task_2_tpool(pool, logout_thread, <span class="literal">NULL</span>);</span><br><span class="line">                epoll_add_event(epoll_fd, logout_fd, EPOLLIN | EPOLLET);</span><br><span class="line">                <span class="comment">// pthread_join(ptd_4, NULL);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">run_server</span><span class="params">()</span> &#123;</span><br><span class="line">    fifo_init();</span><br><span class="line">    profile_init();</span><br><span class="line">    <span class="comment">// thread_init();</span></span><br><span class="line">    monitor();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    signal(SIGTTOU, SIG_IGN);</span><br><span class="line">    signal(SIGTTIN, SIG_IGN);</span><br><span class="line">    signal(SIGTSTP, SIG_IGN);</span><br><span class="line">    signal(SIGHUP, SIG_IGN);</span><br><span class="line">    <span class="type">int</span> pid, i;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        errorinfo(<span class="string">&quot;[x] fork error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NOFILE; close(i++)) &#123;</span><br><span class="line">        <span class="comment">/*改变工作目录，使得进程不与任何文件系统联系*/</span></span><br><span class="line">        chdir(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">/*将文件当时创建屏蔽字设置为0*/</span></span><br><span class="line">        umask(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">/*忽略SIGCHLD信号*/</span></span><br><span class="line">        signal(SIGCHLD, SIG_IGN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    syslog(LOG_USER | LOG_INFO, <span class="string">&quot;my chat_server process start \n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    run_server();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="线程池-threadpool-h"><a href="#线程池-threadpool-h" class="headerlink" title="线程池 threadpool.h"></a>线程池 threadpool.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">work_routine</span><span class="params">(<span class="type">void</span>* args)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">tpool_t</span>* pool = (<span class="type">tpool_t</span>*)args;</span><br><span class="line">   <span class="type">tpool_work_t</span>* work = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       pthread_mutex_lock(&amp;pool-&gt;queue_lock);</span><br><span class="line">       <span class="keyword">while</span> (!pool-&gt;tpool_head &amp;&amp; !pool-&gt;shutdown) &#123;</span><br><span class="line">           pthread_cond_wait(&amp;pool-&gt;queue_ready, &amp;pool-&gt;queue_lock);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(pool-&gt;shutdown)&#123;</span><br><span class="line">           pthread_mutex_unlock(&amp;pool-&gt;queue_lock);</span><br><span class="line">           pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* tweak a work*/</span></span><br><span class="line">        work = pool-&gt;tpool_head;</span><br><span class="line">        pool-&gt;tpool_head = (<span class="type">tpool_work_t</span>*)pool-&gt;tpool_head-&gt;next;</span><br><span class="line">        pthread_mutex_unlock(&amp;pool-&gt;queue_lock);</span><br><span class="line"></span><br><span class="line">        work-&gt;work_routine(work-&gt;args);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(work);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">create_tpool</span><span class="params">(<span class="type">tpool_t</span>** pool,<span class="type">size_t</span> max_thread_num)</span></span><br><span class="line">&#123;</span><br><span class="line">   (*pool) = (<span class="type">tpool_t</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">tpool_t</span>));</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">NULL</span> == *pool)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;in %s,malloc tpool_t failed!,errno = %d,explain:%s\n&quot;</span>,__func__,errno,strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   (*pool)-&gt;shutdown = <span class="number">0</span>;</span><br><span class="line">   (*pool)-&gt;maxnum_thread = max_thread_num;</span><br><span class="line">   (*pool)-&gt;thread_id = (<span class="type">pthread_t</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">pthread_t</span>)*max_thread_num);</span><br><span class="line">   <span class="keyword">if</span>((*pool)-&gt;thread_id == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;in %s,init thread id failed,errno = %d,explain:%s&quot;</span>,__func__,errno,strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   (*pool)-&gt;tpool_head = <span class="literal">NULL</span>;</span><br><span class="line">   <span class="keyword">if</span>(pthread_mutex_init(&amp;((*pool)-&gt;queue_lock),<span class="literal">NULL</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;in %s,initial mutex failed,errno = %d,explain:%s&quot;</span>,__func__,errno,strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(pthread_cond_init(&amp;((*pool)-&gt;queue_ready),<span class="literal">NULL</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;in %s,initial condition variable failed,errno = %d,explain:%s&quot;</span>,__func__,errno,strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; max_thread_num; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pthread_create(&amp;((*pool)-&gt;thread_id[i]),<span class="literal">NULL</span>,work_routine,(<span class="type">void</span>*)(*pool)) != <span class="number">0</span>)&#123;</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;pthread_create failed!\n&quot;</span>);</span><br><span class="line">           <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">destroy_tpool</span><span class="params">(<span class="type">tpool_t</span>* pool)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">tpool_work_t</span>* tmp_work;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(pool-&gt;shutdown)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   pool-&gt;shutdown = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   pthread_mutex_lock(&amp;pool-&gt;queue_lock);</span><br><span class="line">   pthread_cond_broadcast(&amp;pool-&gt;queue_ready);</span><br><span class="line">   pthread_mutex_unlock(&amp;pool-&gt;queue_lock);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; pool-&gt;maxnum_thread; i++)&#123;</span><br><span class="line">        pthread_join(pool-&gt;thread_id[i],<span class="literal">NULL</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">free</span>(pool-&gt;thread_id);</span><br><span class="line">   <span class="keyword">while</span>(pool-&gt;tpool_head)&#123;</span><br><span class="line">        tmp_work = pool-&gt;tpool_head;</span><br><span class="line">        pool-&gt;tpool_head = (<span class="type">tpool_work_t</span>*)pool-&gt;tpool_head-&gt;next;</span><br><span class="line">        <span class="built_in">free</span>(tmp_work);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   pthread_mutex_destroy(&amp;pool-&gt;queue_lock);</span><br><span class="line">   pthread_cond_destroy(&amp;pool-&gt;queue_ready);</span><br><span class="line">   <span class="built_in">free</span>(pool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add_task_2_tpool</span><span class="params">(<span class="type">tpool_t</span>* pool,<span class="type">void</span>* (*routine)(<span class="type">void</span>*),<span class="type">void</span>* args)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">tpool_work_t</span>* work,*member;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!routine)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;rontine is null!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   work = (<span class="type">tpool_work_t</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">tpool_work_t</span>));</span><br><span class="line">   <span class="keyword">if</span>(!work)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;in %s,malloc work error!,errno = %d,explain:%s\n&quot;</span>,__func__,errno,strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   work-&gt;work_routine = routine;</span><br><span class="line">   work-&gt;args = args;</span><br><span class="line">   work-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">   pthread_mutex_lock(&amp;pool-&gt;queue_lock);</span><br><span class="line">   member = pool-&gt;tpool_head;</span><br><span class="line">   <span class="keyword">if</span>(!member)&#123;</span><br><span class="line">        pool-&gt;tpool_head = work;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(member-&gt;next)&#123;</span><br><span class="line">           member = (<span class="type">tpool_work_t</span>*)member-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        member-&gt;next = work;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//notify the pool that new task arrived!</span></span><br><span class="line">   pthread_cond_signal(&amp;pool-&gt;queue_ready);</span><br><span class="line">   pthread_mutex_unlock(&amp;pool-&gt;queue_lock);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="tpool-h"><a href="#tpool-h" class="headerlink" title="tpool.h"></a>tpool.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> T_POOL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_POOL</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tpool_work</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>* (*work_routine)(<span class="type">void</span>*);  <span class="comment">// function to be called</span></span><br><span class="line">    <span class="type">void</span>* args;                    <span class="comment">// arguments</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tool_work</span>* <span class="title">next</span>;</span></span><br><span class="line">&#125; <span class="type">tpool_work_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tpool</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> shutdown;       <span class="comment">// is tpool shutdown or not, 1 ---&gt; yes; 0 ---&gt; no</span></span><br><span class="line">    <span class="type">size_t</span> maxnum_thread;  <span class="comment">// maximum of threads</span></span><br><span class="line">    <span class="type">pthread_t</span>* thread_id;  <span class="comment">// a array of threads</span></span><br><span class="line">    <span class="type">tpool_work_t</span>* tpool_head;    <span class="comment">// tpool_work queue</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> queue_ready;  <span class="comment">// condition varaible</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> queue_lock;  <span class="comment">// queue lock</span></span><br><span class="line">&#125; <span class="type">tpool_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">create_tpool</span><span class="params">(<span class="type">tpool_t</span>** pool, <span class="type">size_t</span> max_thread_num)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">destroy_tpool</span><span class="params">(<span class="type">tpool_t</span>* pool)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add_task_2_tpool</span><span class="params">(<span class="type">tpool_t</span>* pool, <span class="type">void</span>* (*routine)(<span class="type">void</span>*), <span class="type">void</span>* args)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6963589249463500831#heading-3">https://juejin.cn/post/6963589249463500831#heading-3</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/blogs/381801">https://bbs.huaweicloud.com/blogs/381801</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>7r1p13J</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/"># 系统编程</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2023/01/11/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">syzkaller初探</a>
            
            
            <a class="next" rel="next" href="/2022/12/17/CVE-2022-0847/">CVE-2022-0847 ditry-pipe 漏洞分析与利用</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© 7r1p13J | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>